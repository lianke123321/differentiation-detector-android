\section{Implementation}
In this section, we describe our current deployment, we discuss how we addressed several 
challenges toward achieving the goals listed in the previous section and 
we present empirical results demonstrating the feasibility of our approach 
in terms of reasonably low overhead. 

\subsection{Meddle Details}
To facilitate widespread adoption, \meddle is
supported out-of-the-box by the vast majority of smart mobile devices (smartphones and tablets) and 
is easy to deploy on servers. Manually installing a VPN generally requires filling out five
fields on a Android phone, and the VPN configuration can be
distributed using a single file on iOS. 



\tbd{Ashwin: Insert primer on VPNs.}

\noindent\textbf{iPhone support.} We support \meddle on iOS using the ``VPN On-Demand'' feature, 
introduced in version 3.0 of iOS. This was originally intended to allow enterprises to 
ensure their employees' devices always establish a VPN connection before contacting 
a specified set of domains. Using trial-and-error, we discovered that VPN On-Demand uses 
suffix matching to determine which domains require a VPN connection. 

We use each alphanumeric character as the set of domains that require a VPN 
connection. This ensures that a connection is established before \emph{any} network 
activity.

\noindent\textbf{Android support.} As of Android 4.2, Android supports 
``always on'' VPN connections that ensure all traffic is always tunneled. 
At the time of writing, this has been released only for one week and only 
for a subset of Android devices so we have not extensively tested the 
effectiveness of the solution. 

Instead, we rely on a feature that allows apps to manage VPN connections, 
introduced in Android 4.0. We modified the StrongSwan implementation of 
a VPN client to ensure that the VPN reconnects each time the preferred 
network changes (\eg, when a device switches from cellular to WiFi). 

\noindent\textbf{Server-side implementation.} In our current implementation, \meddle 
uses native IPsec, implemented via StrongSwan~\cite{strongswan}, to establish VPN tunnels 
and Vyatta middlebox software \tbd{AL: give a reference} to shape
traffic. Both of these software artifacts are supported on vanilla
Linux operating systems, which in turn run on nearly all servers. 
   
\subsection{Feasibility}
\label{subsec:cost}
Because our approach in part depends on users installing a VPN configuration and tunneling all traffic through \meddle, we evaluate whether the cost to the user in terms of performance, power and data quota is sufficiently low.

\noindent\textbf{Power consumption.} Tunneling traffic to a \meddle
server requires that all traffic be encrypted by the mobile
device. While this is already commonly performed for SSL connections,
\meddle requires an \emph{additional} layer of encryption. We observed
a 10\% increase in power consumption when streaming an HD video to
Android and iPhone devices using our IPsec tunnel. We believe that this 
overhead is reasonably low, and we note that this cost for encryption comes with the added benefit of increased 
privacy from carriers.

An interesting research question is whether it is possible to \emph{reduce} power consumption using \meddle. For example, Qian et al~\cite{qian:rrc,qian:aro,qian:periodic} found that traffic shaping (a service that \meddle provides) can significantly reduce the power consumed by devices when periodic application traffic and radio resource timers are out of sync.

\tbd{Ashwin: Add newer analysis}
  
\noindent\textbf{Data consumption.} IPsec encapsulation slightly inflates packet sizes, in addition to
preventing carrier middleboxes from applying their own compression. We
measured the overhead of the tunnel in terms of data overhead from IPsec 
headers and keepalive
messages, finding that it ranges from 8--12\%. For our measurements, we setup \meddle
as a VPN gateway for an iPhone and Android phone. On each phone,
we accessed the Internet using the VPN tunnel for about one hour. Our
test traffic was generated by activities that we expect to be typical of mobile 
device usage: Web searches, map searches, online shopping, 
downloading popular apps, emailing and reading the news. We also uploaded a picture to 
Facebook and Twitter, streamed a video on YouTube, and played a popular game (Angry Birds). 
%In terms of dollars, this corresponds to YYY. Keep-alive messages?

\noindent\textbf{Performance.} By forcing user traffic to an
intermediate server and interposing on flows, we may add latency both
due to additional hops and due to processing time at the \meddle
server. We envision a DONAR-style deployment where users are
dynamically redirected to different \meddle servers based on network
conditions and server load~\cite{wendell:donar}. Given this model, we
evaluate whether we can locate servers near mobile-network egress
points using a deployment such as PlanetLab, and found that this is
generally the case.

For this experiment, 
we used data from approximately 10 mobile phones located throughout
the US and issued traceroutes from the devices to targets in Google
and Facebook's networks. We then used the first non-private IP address seen 
from the mobile device on the path to a server. We assume that this corresponds 
to the first router adjacent to the mobile carrier's public Internet egress point. Note that we could not simply ping the device IPs because mobile carriers filter inbound ping requests. Using this set of egress adjacencies, we determined the round-trip time from each PlanetLab site, then took the average of the nearest five sites to represent the case where a host at the nearest site is unavailable due to load or other issues. The average latency to each router was between 3\,ms and 13\,ms, with a median of 5\,ms. Thus, when compared to RTTs of 10s or 100s of milliseconds that exist in mobile networks, the additional latencies from traversing \meddle servers is expected to be relatively small or even negligible.

\tbd{What is the cost in terms of end-to-end performance?}

\tbd{Are there cases where we actually improve performance due to
detouring? (I've decided not to mention this because it's not a sure thing.)}
\tbd{In case the carrier is performing traffic differentiation to
  penalize some bandwidth consuming traffic, using a VPN might
  significantly improve performance. I don't know whether traffic
  differentiation is something common on mobile networks. (that was an
  answer to Dave question. If he discards it, also drop my comment.) }


\noindent\textbf{Scalability.} If wildly successful, we would like to
ensure that \meddle scales gracefully and that there are sufficient
resources to support large numbers of concurrent users
worldwide. Based on our initial analysis using StrongSwan on commodity
hardware, we found that each connection consumed on average less than
1\% of CPU time. Thus, we expect to be able to support up to 100s or
small number of thousands of users per server, which is in line with
low-end VPN appliances sold by Cisco and Vyatta. A recent
study~\cite{pcworld-speedtests} showed that current rates for 3G
networks in the US were between 0.59 and 3.84 Mbps; assuming devices
are uniformly distributed across carriers, we expect to be able to
support 250 simultaneous users (saturating their download capacity)
for every 1 Gbps of bandwidth at the server.

\subsection{Current Deployment}
The analysis in the following sections rely on data gathered from 
our current prototype deployment. This consists of \meddle servers at the University of Washington, 
UC Berkeley and Inria, along with 20 devices from 14 users participating 
in an IRB-approved study. 

\noindent\textbf{Summary statistics.} \meddle has been running 
since September 2012. The deployment includes 8 Android devices 
and 12 iOS devices (4 iPads, 7 iPhones and 1 iPod Touch). These 
devices connect to \meddle via 15 different service providers, 
XX of which are cellular providers. Together, our users have 
generated 30.2\,GB of traffic since November 1, 2012. 

\noindent\textbf{Data collected.}
We collect full packet traces from these users 
(with informed written consent) and we code the data using random identifiers 
to protect identities. We do not attempt to decrypt any SSL traffic, 
and all packet traces are encrypted using a public key before being 
stored on disk. The private decryption key is stored on a separate server. 
Users may opt out and choose to delete their data at any time. 

While this fine-grained data is useful for informing the design of meddlebox solutions (\eg, 
identifying and stripping personally identifiable information from unencrypted 
HTTP traffic), it can be prohibitive for a large-scale study. In the next phase of 
our deployment (currently under IRB review) we will capture only packet headers 
and lengths. With a lower privacy risk, we believe we can recruit a larger number 
of users and obtain informed consent via a Web site. 

   

 
 
%  IPsec support on mobile devices 
%       + IKEv1 with Certificates for iOS and Android
%       + On demand on iOS fully supported
%       + Android 4.2 has always on but not on demand 
%           - short comings on IP and not host names
%           - no IKEv2 support - faster and less connection 
%       + Strongswan APP 
%           - support ICS, and Jellybean  
%           - added functionality to have always ON
%       + Strongswan on the server 
%           - Native IPSec support, 
% - Servers in UW, berkeley, and Inria. 
% - Openvswitch based middleboxes ?? (Justines inputs needed here) 
%** System Feasibility
% - VPNs by Smartphones
%   - IKEv1 and IKEv2 
%   - Short VPN Primer comes here 
% - Network overheads (data and latency)
%   - Signalling overheads - from Strongswan   
%   - Headers in each packet - from IPsec standards 
%   - Other overheads
%   - (Ideas for VPN issues and improvements of VPN for Mobile networks)
% - Power overheads (Inputs from Aruna on the time required to perform these tests)
%   - Cannot do this for iOS but we can do a test with power up and down
%   - Power meter setup
%      - Devices used in the test            
%   - Test case description ( Do we have time for this??)
%         - factory reset the device (stop all apps that have been installed by the user)
%         - Perform the test with and without VPN
%              - browse the web with and without VPN - Select websites domain from alexa top sites
%              - Install 5 most popular games from the store for atleast 15 minutes
%              - Listen to Music, Pandora, TuneIn radio (1 hour per app -- about 10 songs to include ads)
%              - See 5 videos from YouTube                  
%   - Test results
% - User Concerns and Security Risks (do we need it here??)
%   - Privacy implications - IRB to ensure user privacy is not violated
%   - Server failures - VPN tunnel shall not be established but  
%   - EULA that allows us to block malicious user activity
