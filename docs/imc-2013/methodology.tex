\section{Methodology and Dataset}
\label{sec:Methodology}

We used \platname to characterize mobile Internet traffic, and detail the impact of access technology and operating systems on application behavior. 

Our analysis methodology included controlled experiments to detail the behavior of specific applications and OS services, and a 7-month long IRB approved measurement study to characterize mobile Internet traffic in the \emph{in the wild} . 

\subsection{Controlled Experiments}

For our controlled experiments, we ran the latest versions of Android (Ice Cream Sandwich 4.0, and Jelly-bean 4.2) and iOS 6 respectively on our Android and iOS devices. 
We analyze the behavior of OS services and the default applications by first performing a factory reset on these devices, and installing the \platname credentials on this device.
We then test Android and iOS applications by installing the application, interacting with the application for a few minutes, and finally uninstalling the  application. 
During our controlled experiment we use SSL-Bumping to study the behavior of SSL traffic from these applications. 

Our first experiment included manual testing of the top 100 most popular free Android apps from the \emph{Google Play} store and \tbd{} iOS applications from the iOS App store.
For this experiment we first manually installed each application by hand, enter user credentials for accounts like Facebook and Twitter, and toy with the app for \tbd{} minutes. 
In addition to this manual setup, we used an automatic test-click generator to further toy with the Android applications for \tbd{} actions. 
We did not perform this automation step while testing the the iOS applications.
We then uninstall the application and reset the device to test the next application. 

For our second experiment we performed fully-automated tests on 1003 Android applications from a free, third-party Android market.
We perform this test because Android devices can install \emph{Third-party applications} that are not available on the \emph{Google Play} store.
A consequence of this freedom is that numerous third-party app markets are available on the web whose applications have not received research attention.
Our automation used the adb Android command shell to install each app, enable \platname, and start the app.
The system then used Monkey, an adb stress tool, to perform a series of 10,000 actions. 
These actions included random swipes, touches, and text entries.
We then used adb to uninstall the application and reboot the device to forcibly end any lingering connections.

The results of the controlled experiments can be found in \fref{sec:manual-testing}.

\subsection{In The Wild Measurements}

Along with controlled experiments we also conducted a measurement study to characterize the mobile Internet in the wild.
We now present the description of the dataset and the methodology we used to classify the traffic in this dataset.

\subsubsection{Dataset Description}

For this study, we deployed two \platname servers, one in USA and one in France, to proxy Internet traffic from 26 devices, 10 iPhones, 4 iPads, 1 iPodTouch, and 11 Android phones.
The Android devices in this dataset include the Nexus, Sony, Samsung, and Gsmart brands while the iPhones include one iPhone~3gs, five iPhone~5, and five iPhone~4S.
These devices belonged to 21 users, volunteers for our IRB approved study.
%To protect the identity of the users and their data, we used public key cryptography to encrypt the \emph{pcap} files that log the data traffic flowing through our \platname servers. 
This dataset, called \mobWild, consists of 218 days of data that flowed through our \platname servers; the number days for each user varies from 5 to 215 with a median of 35 days.
We would like to point out that though we performed SSL-Bumping during our controlled experiments, we did not perform SSL-Bumping for the traffic in this dataset.

\subsubsection{Ethical Issues}

Capturing all of a subject's Internet traffic raises significant
privacy concerns. Our IRB-approved study entails informed consent from
subjects who are interviewed in lab, where the risks and benefits of
our study are clearly explained. Subjects are incentivized to use the
VPN though a lottery for Amazon.com gift certificates. All data from
tcpdump is encrypted before touching persistent storage; the private
key is maintained on separate secure severs and only approved
researchers can access it. Users may delete their data and/or disable
monitoring at any time. For privacy reasons, we cannot make this data
publicly available.


\subsubsection{Identification of Access Technology}

A mobile devices can tunnel the traffic through our \platname servers using either \wifi or cellular networks. 
We estimate the access technology with the description of the AS through which the mobile client connects to our \platname server. 
We get this AS description by performing a \emph{WHOIS} lookup on the IP address used by the mobile client to tunnel Internet traffic. 
For our analysis, we use the WHOIS databases available at \emph{whois.cmyru.com} and \emph{utrace.de}.
We use the information from these \emph{WHOIS} databases to manually classify the ASes to be either cellular or \wifi.
Our dataset consists of data traffic from 54 distinct ASes, of which we classify 9 to be belong to cellular networks.
The devices connected to our system from at most two cellular ASes.
In contrast, a median of 4 \wifi ASes were observed per device and for one device we observed traffic from 25 different \wifi ASes that are spread across 5 countries. 


\subsubsection{Traffic Summary}

\begin{table}
\begin{small}
\begin{center}
\begin{tabular}{|p{0.15\columnwidth}|p{0.12\columnwidth}|r|r|r|r|}
\hline
\multirow{2}{*}{\bf IP Protocol} & \multirow{2}{*}{\bf Service} & \multicolumn{2}{|c|}{\bf Android} & \multicolumn{2}{|c|}{\bf iOS} \tabularnewline
\cline{3-6}
           &           &  \textbf{Cell.}  &  \textbf{\wifi}  &  \textbf{Cell.}  &  \textbf{\wifi}  \tabularnewline
\hline
\multirow{3}{*}{TCP}
       &  HTTP  & 35.386 & 68.686 & 52.109 & 75.506 \tabularnewline
\cline{2-6}
       &  SSL   & 61.135 & 27.366 & 46.765 & 18.777 \tabularnewline
\cline{2-6}
       &  other & 2.346  & 3.290  & 0.256  & 1.818 \tabularnewline
\hline
\multirow{2}{*}{UDP}
       &  DNS   & 0.682  & 0.496  & 0.545  & 0.305  \tabularnewline
\cline{2-6}
       &  other & 0.316  & 0.098  & 0.286  & 3.583  \tabularnewline
\hline
 Other &  -     & 0.135  & 0.064 & 0.039  & 0.011  \tabularnewline
\hline
\multicolumn{2}{|c|}{\emph{total}} & 100.00 & 100.00 & 100.00 & 100.00 \tabularnewline
\hline
\end{tabular}
\end{center}
\end{small}
\caption{Traffic volume (in percentage) of popular protocols and services on Android and iOS devices over cellular and \wifi.
\emph{TCP flows are responsible for more than 90\% of traffic volume. Traffic share of SSL over cellular networks is more than twice the traffic share of SSL over \wifi.}} 
\label{tab:summaryIOSAndroidTraffic}
\end{table}

We used Bro~\cite{bro} to analyze the traffic the passed through our \platname servers.
In \fref{tab:summaryIOSAndroidTraffic} we summarize \mobWild based on the classification performed using Bro~\cite{bro}.
Bro classifies IP flows using the protocol field in the IP header.
We use this classification to label flows as either TCP, UDP, or \emph{other}; flows that are neither TCP nor UDP are classified as \emph{other}. 
Bro further uses the well defined port numbers to identify the services that use TCP.
We use this classification to label flows as either HTTP, SSL (which includes HTTPS, IMAP, etc.) or \emph{other} flows; TCP flows that are not classified as either HTTP or SSL are classified as \emph{other}.
In \fref{tab:summaryIOSAndroidTraffic}, we observe that more than 90\% of the traffic in our dataset is either HTTP or SSL. 
We also observe that the share of HTTP volume over \wifi and cellular are significantly different. 
As detailed in \fref{sec:.}, this difference is primarily due to the use of \wifi to transfer media content.
We also observe the share of SSL traffic over cellular networks is considerably larger compared to \wifi networks.
This increase is a result of the reduced share of media traffic and the use of email and for social networking applications that rely on SSL.
We detail the HTTP and SSL traffic from iOS and Android devices in \fref{sec:}

We focus our application classification on TCP because TCP is responsible for than 90\% of the traffic volume in our dataset (see~\fref{tab:summaryIOSAndroidTraffic}).
Furthermore more than 95\% of the TCP traffic is due to SSL and HTTP.
We therefore focus our attention on HTTP and SSL traffic. 

\subsubsection{Classification of HTTP Traffic}

The HTTP headers for HTTP Request, HTTP Response, and HTTP Entity contain a wealth of information including \useragent, \emph{Referrer}, \emph{Content-Type}, and \emph{Content-Encoding} that can be used to classify HTTP traffic~\cite{rfc:http}.
Recent studies on mobile traffic classification have relied heavily on the \useragent field to classify mobile HTTP traffic~\cite{qian:webcache, maier:mobtraffic, xu:appusage}.
We quantify the usefulness of the \useragent field and show how other fields such as \httphost are essential to characterize mobile HTTP traffic. 

Webservices are known to use the \useragent field to distinguish flows from their mobile applications from the flows originating from Web-browsers.
We observe that more than 98\% of HTTP traffic from Android and iOS devices in the \mobWild dataset have a valid \useragent string; we observe a total of 1435 unique \useragent strings across Android and iOS devices. 
In these \useragent strings we observe that along with the application identifier, the \useragent strings also contain details of the OS, manufacturer, display resolutions, carrier, and other information such as versions and compatibility with other browser engines. 
We use regular expression to extract the tokens containing the application information and we then cluster these tokens using edit distance between individual tokens and number of matching tokens. 
We plan to release this code along with \platname package.
At the end of this process we were able to identify 361 unique application signatures.
We use the extracted application signature to label the HTTP traffic that flows through \platname.

\begin{figure}
\includegraphics[width=\columnwidth]{plots/appusage_someappsig_traffic.pdf}
\caption{HTTP traffic with a \useragent field containing an identifier of an application (other than Web-browser) or an OS service. 
\emph{A smaller share of Android HTTP traffic can be classified using User-Agents because Android applications are not limited to underlying OS media services such as AppleCoreMedia.}}
\label{fig:http-classification-app-user-agent}
\end{figure}

In \fref{fig:http-classification-app-user-agent} we plot the fraction of HTTP traffic for we were able to identify an application signature; the devices are ordered according to the operating system, and for each operating system we further order the devices according to the total traffic from the device that flowed through \platname. 
We observe that a significantly larger fraction of traffic from iOS device can be mapped to an application in comparison to the traffic from Android devices. 
For example, while more than 80\% of HTTP traffic from iOS devices contain an application or OS service signature in the \useragent field, only 23.9\% and 19.5\% from Android devices with id 16 and 18 contained useful signatures in the \useragent field.
On further inspection we observe that this difference is because of the techniques used by Android and iOS application to download audio and video content. 

\begin{figure}
\includegraphics[width=\columnwidth]{plots/appusage_someappservicesig_traffic.pdf}
\caption{HTTP traffic classified using \useragent or \httphost field provided by popular media services in the HTTP header. \emph{The rest of the traffic is either from Web-browsers and flows that do not include any application signatures in the \useragent field.}}
\label{fig:http-classification-app-user-agent-host}
\end{figure}

We observe that the iOS devices primarily download media content using the AppleCoreMedia service~\cite{apple:coremedia}.
We therefore observed a signature for AppleCoreMedia in the \useragent string for more than 98.45\% of the content downloaded from the YouTube servers (which we identify based on the \httphost field in the \httpget requests). 
We also observed AppleCoreMedia signatures in the content fetched from other media sites such as Netflix and iTunes.
Though Android provides a similar service, Stagefright\cite{android:stagefright}, we observe that only 41.91\% of YouTube content in our dataset was fetched using Stagefright in the \useragent field. 
Similarly, we observed content from other media sites were fetched without any unique signatures in the \useragent field. 
Therefore, because HTTP traffic for Android devices cannot be classified solely based on the \useragent field, and most of the unclassified traffic was media content, we use the \httphost field to further classify flows that do not contain a signature in the \useragent field. 
\tbd{Results to show when Stagefright is used and when it is not based on controlled experiments performed}

In \fref{fig:http-classification-app-user-agent-host} we present the HTTP traffic share that we could classify using the \useragent and \httphost field in the HTTP headers. 
The rest of the flows belong to traffic from Web-browsers and those that do not include any signatures in the \useragent field. 

\subsubsection{Classification of SSL Traffic.}

Unlike HTTP flows, SSL flows provide limited information that can be used to identify the applications. 
We now show how we used the \sslservername and the DNS queries to classify SSL traffic. 

\begin{figure}[t]
\includegraphics[width=\columnwidth]{plots/sslanalysis_someservername_traffic.pdf}
\caption{SSL flows classified using the \sslservername in the flows.}
\label{fig:ssl-classification-servername}
\end{figure}
\begin{figure}[t]
\includegraphics[width=\columnwidth]{plots/sslanalysis_samedns_traffic.pdf}
\caption{SSL traffic share where the most recent DNS response contained the IP address of the SSL flow in the first position.}
\label{fig:ssl-classification-app-service}
\end{figure}


In \fref{fig:ssl-classification-servername} we observe that relying on the \sslservername is not sufficient to classify the traffic. 
We observe a huge disparity in the fraction of traffic that can be classified using this technique.
Along with the \sslservername, the common name field of the certificate can be used to identify the traffic. 
However, the use of CDNs and the use of regular expression to support a large set of hostnames gives a us a result similar to that observed in \fref{fig:ssl-classification-servername}.

\tbd{The plot can be removed and the discussion with CN field can be merged to indicate relying on certificates and server-names on their own is not sufficient}
% \begin{figure}
% \includegraphics[width=\columnwidth]{plots/sslanalysis_dns_timediff_distrib.pdf}
% \caption{Distribution of the time between DNS response that contained the IP address of the SSL server and the SYN from the SSL flows. 
% \emph{The lack of difference in the curves for Android devices implies that the first entry in the most recent DNS response contained the IP address of the SSL flow.\tbd{rename xlab to DNS response.}}}
% \label{fig:ssl-dns-first-recent-distrib}
% \end{figure}

% To analyze the impact of the ambiguity, in \fref{fig:ssl-dns-first-recent-distrib} we plot the distribution of the time between the DNS response that contained the IP address and SYN packet from the SSL flow. 
% For this plot, we consider two types of DNS responses: the most recent DNS response that contain the IP address in the SSL flows, and the most recent DNS response that contained the IP address as the first entry in the DNS response. 
% We observe that for Android flows we do not observe a difference in the curves for the distribution, implying that the first entry in the most recent DNS response contained the IP address of the SSL flow.
% However, for iOS devices we observe a difference in the distribution when the time difference between the SYN and DNS response is larger than three seconds. 
% This difference creates an ambiguity which can be aggravated by caching of name resolution by the applications. 

We use the DNS flows that passed through \platname to further classify the SSL flows, a technique similar to DN-Hunter~\cite{bermudez:dnhunter}.
DN-Hunter relies on the most recent FQDN that corresponds to the IP address, however in our controlled experiments we observe Android and iOS devices prefer the the first entry in DNS response while resolving \emph{hostnames}.
Popular webservices such as google are known to use the same pool of IP addresses for various applications, for example the IP for gmail may also be used for search. 
In \fref{fig:ssl-classification-app-service} we present the fraction of SSL traffic where the most recent DNS response contained the IP address of the SSL flow in the first position. 
We observe that for the majority of SSL traffic by volume and flows can be classified by using the DNS responses. 

In summary, we use \platname to perform controlled experiments and in the wild measurements to characterize mobile Internet traffic. 
We use Bro to analyze the data and build on the output of bro to further classify HTTP flows and SSL flows to identify the source of the traffic. 
We now present the results of our experiments and measurements study. 


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "main"
%%% End: 
