#!/bin/bash
#This script takes a directory name, reads all the apks in it.
# It installs each apk onto the phone. Then it runs a 10,000 monkey random actions.
# It then uninstalls and reflashes (with an image optionally).

fileList="./cymru-detected-malware-apks.txt"
apkFolder="./allapks/"
apkTimeStamp="./apktimestamps.txt"
devicePassword="meddlepw"
wirelessDevice="wlan0"

# Restart the device to enter a clean state
adb reboot
echo "Sleeping for device to come up"
sleep 20
while [ -z "$(adb shell getprop sys.boot_completed | grep 1)"  ]
do
   echo "The device is still not up"
   sleep 1
done
cnt=0
apkCnt=`wc -l ${apkTimeStamp} | cut -d ' ' -f 1`
while read fileId
do
  if [ "${cnt}" -ge "${apkCnt}" ];
  then
      apkName=${apkFolder}/${fileId}
      echo "Time to test ${apkName}"
      break
  fi 
  cnt=$((cnt+1))
  echo "Skipping ${line} at index ${cnt}"
done < ${fileList}

adb shell input text ${devicePassword}
adb shell input keyevent 66

echo "Sleeping for wireless device to get IP"
sleep 5
while [ -z "$(adb shell netcfg | grep ${wirelessDevice} | grep UP)" ]
do
    echo "Wireless Device is not up"
    sleep 1
done
sleep 3

echo "Waiting for Meddle to start"
#wait for meddle to start
while [ -z "$(adb shell ps | grep 'org.strongswan.android')" ]
do
   echo "Meddle is still not running"
   sleep 1
done

packagename=$(aapt dump badging "${apkName}" | grep "package" | awk -F ' ' '{print $2}' | awk -F "'" '{print $2}')
launchname=$(aapt dump badging "${apkName}" | grep "launchable-activity" | awk -F ' ' '{print $2}' | awk -F "'" '{print $2}')
echo "Creating the tunnel"
#Create Meddle VPN tunnel
adb shell input keyevent 66; adb shell input keyevent 61; adb shell input keyevent 61; adb shell input keyevent 66
echo -n -e "$fileId |  $packagename | $(date +%s) | $(date)" >> ${apkTimeStamp}
echo "Sleeping for the tunnel to be created"
sleep 5
echo "FILENAME: "  "${apkName}"
echo "PACKAGE:  + ${packagename}"
adb install ${apkName}
echo "START PLAYING WITH ${apkName} ${packagename}"
echo "${packagename}/${launchname}"
echo "adb shell am start -n ${packagename}/${launchname}"

