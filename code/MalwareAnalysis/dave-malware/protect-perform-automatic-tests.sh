#!/bin/bash
#This script takes a directory name, reads all the apks in it.
# It installs each apk onto the phone. Then it runs a 10,000 monkey random actions.
# It then uninstalls and reflashes (with an image optionally).

fileList="./apkList.txt"
apkFolder="./apks/"
apkTimeStamp="./apkTimestamps.txt"
devicePassword="meddlepw"
wirelessDevice="wlan0"

cnt=0
totApks=`wc -l ${fileList}`
touch ${apkTimeStamp}
apkCnt=`wc -l ${apkTimeStamp} | cut -d ' ' -f 1`
apkCnt=$((apkCnt+1))
echo "Starting from ${apkCnt} of ${totApks}"
while [ "${apkCnt}" != "${totApks}" ];
do
    apkName=`sed -n "${apkCnt},${apkCnt}p" ${fileList}`
    echo ${apkName}
    adb reboot
    echo "Sleeping for device to come up"
    sleep 20
    while [ -z "$(adb shell getprop sys.boot_completed | grep 1)"  ]
    do
	echo "The device is still not up"
	sleep 1
    done
    cnt=0
    
    adb shell input text ${devicePassword}
    adb shell input keyevent 66

    echo "Sleeping for wireless device to get IP"
    sleep 5
    while [ -z "$(adb shell netcfg | grep ${wirelessDevice} | grep UP)" ]
    do
	echo "Wireless Device is not up"
	sleep 1
    done
    sleep 3

    echo "Waiting for Meddle to start"
    #wait for meddle to start
    while [ -z "$(adb shell ps | grep 'org.strongswan.android')" ]
    do
	echo "Meddle is still not running"
	sleep 1
    done
    adb shell input keyevent 66; adb shell input keyevent 61; adb shell input keyevent 61; adb shell input keyevent 66
    
    packagename=$(aapt dump badging "${apkFolder}/${apkName}" | grep "package" | awk -F ' ' '{print $2}' | awk -F "'" '{print $2}')

    echo -n -e "${apkCnt} | $packagename | $(date +%s) | $(date)" >> ${apkTimeStamp}

    echo "Starting Monkey for iteration package ${packagename}"
    
    adb install ${apkFolder}/${apkName}
    adb shell monkey -p ${packagename} --pct-majornav 0 --pct-syskeys 0 --pct-appswitch 0 --kill-process-after-error --throttle 500 1000
    adb uninstall "$packagename"
    echo "| $(date +%s) | $(date)" >> ${apkTimeStamp}
    apkCnt=$((apkCnt+1))    
done

