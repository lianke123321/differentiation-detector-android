baseDir<-"/home/arao/proj-work/meddle/projects/meddle_malware_data/"
#baseDir<-"/user/arao/home/controlled_experiments/malware_tests/loge/meddle_malware_data/"
scriptsDir<-paste(baseDir, "/parsing-scripts/", sep="")
broLogsDir<-paste(baseDir, "/bro-results/malware-test/", sep="")
miscDir<-paste(baseDir, "/miscData/", sep="")
resultsDir<-paste(baseDir, "/results/", sep="")
testID <- "dave-manual-1";
setwd(scriptsDir);


source(paste(scriptsDir, "readLogFiles.R", sep=""))

########################################################################
########################################################################
######### ALL FUNCTIONS COME HERE ######################################
########################################################################
########################################################################
########################################################################
#trackerTable <- loadTrackerTable(namedTrackerFile)
#write.table(trackerTable, paste(miscDir, "trackerList.txt", sep=""), sep="\t", 
#            quote=F, col.names=c(colnames(trackerTable)), row.names=FALSE, fileEncoding="utf-8")
getHttpParams <- function(uri) {
  #uri <- /cooguogw/list2.action?appCount=0&requestId=2"
  pageList <- rep(0, length(uri))
  paramNameList <- rep(0, length(uri))
  paramValueList <- rep(0, length(uri))
  for (i in 1:length(uri)) {
    splitURI <- unlist(strsplit(uri[i],"?", fixed=TRUE))  
    page <- splitURI[1]
    paramNames <- ""
    paramValues <- ""       
    if (length(splitURI)>1) {
      params <- splitURI[2]
      splitParams <- unlist(strsplit(params, "&", fixed=TRUE))
      for(j in 1:length(splitParams)) {
        x <- splitParams[j]
        x <- unlist(strsplit(x, "=", fixed=TRUE))
        if (length(x)>=2) {
          paramNames <- paste(paramNames,x[1],sep=",")          
          #paramNames <- paramNames.append(x[1])
          paramValues <- paste(paramValues, paste(x[2:length(x)], collapse=""), sep=",")
          #paramValues <- paramValues.append(paste(x[2:length(x)], collapse=""))
        }    
      }   
    }
    pageList[i] <- page;
    paramNameList[i] <- paramNames
    paramValueList[i] <- paramValues
  }
  return (list(page=pageList, paramNames=paramNameList, paramValues=paramValueList))
}

getLengthMatrix <- function(lst) {
  lengthMatrix <- matrix(0, nrow=length(lst), ncol=length(lst))   
  y <- nchar(lst)    
  for (i in (1:(length(y)))) {    
    x <- y[i];
    lengthMatrix[i,] <- pmax(x, y)
  }
  return(lengthMatrix)
}

getNameDistance <- function(lst) {
  distMatrix <- matrix(0, nrow=length(lst), ncol=length(lst))     
  lengthMatrix <- matrix(1, nrow=length(lst), ncol=length(lst))
  nameSets <- strsplit(lst,",",fixed=TRUE)     
  for (i in (1:(length(nameSets)))) {    
    if (i%%50==0) {
      print(i)    
    }
    distMatrix[i,i] <- 0
    x <- unlist(nameSets[i])
    #print(x)
    if (length(x) > 0) {
      for(j in ((i+1):length(nameSets))) {
        y <- unlist(nameSets[j])
        if (length(y) >0) {
          z <- max(length(x), length(y))
          y <- length(setdiff(x, y))                  
          #print(paste(i,j,y))          
          distMatrix[i,j] <- y
          distMatrix[j,i] <- y  
          lengthMatrix[i,j] <- z
          lengthMatrix[j,i] <- z
        }
      }
    }    
  }  
  return (list(distMatrix=distMatrix, lengthMatrix=lengthMatrix))
}

getTrafficGenMalware <- function(inpData) {
  genTraffic <- aggregate(inpData[c("num_flows")],
                          by=list(malwareFamily=inpData$malwareFamily,
                                  malwareID=inpData$malwareID),
                          FUN=sum)
  genTraffic$traffic_gen_malware <- 1;
  genAggr <- aggregate(genTraffic[c("traffic_gen_malware")],
                          by=list(malwareFamily=genTraffic$malwareFamily),
                          FUN=sum)
  return(genAggr)
}

computeDistanceMatrix <- function(method, page, paramNames, paramValues) {
  # Method distance (0,1)
  print("Method")
  methodMatrix <- adist(method,fixed=TRUE) 
  methodMatrix[methodMatrix>0] <- 1;  
  
  print("Page")
  # Normalized edit distance range(0,1)
  pageMatrix <- adist(tolower(page))  
  lenMatrix <- getLengthMatrix(page)  
  pageMatrix <- pageMatrix/lenMatrix
  
  #Value Matrix
  print("Value")
  valueMatrix <- adist(tolower(paramValues))  
  lenMatrix <- getLengthMatrix(paramValues)  
  valueMatrix <- valueMatrix/lenMatrix    
  
  # Name Matrix <- jacard distance
  print("Name")
  nameDistance <- getNameDistance(paramNames)
  nameMatrix <- 1-(nameDistance$distMatrix/nameDistance$lengthMatrix)  
  return (list(methodMatrix=methodMatrix, pageMatrix=pageMatrix, 
               nameMatrix=nameMatrix, valueMatrix=valueMatrix))
}

loadTrackerTable <- function(namedTrackerFile) {
  namedTrackerTable <- read.table(namedTrackerFile, header=FALSE, sep="\"", fill=TRUE,
                                  col.names=c("zone", "domain", "misc1", "misc2", "misc3"),
                                  stringsAsFactors=FALSE, quote="",comment.char = "/", )
  trackerTable <- data.frame(domain=namedTrackerTable$domain, stringsAsFactors=FALSE)
  return(trackerTable)
}

assignTrackerFlag <- function(trackerDomains, inpData) {  
  # TODO:: Read from Database the list of trackers and assign a tracker based on httpData
  print("Assigning Tracker Flags")  
  # Assuming that number of http flows are larger than the tracker rows~3k
  trackerRows <- unique(unlist(lapply(trackerDomains,  function(x) {grep(x, inpData$host)})))  
  inpData$tracker_flag <- FALSE;
  if (length(trackerRows) > 0) { 
     inpData[trackerRows, ]$tracker_flag <- TRUE;
  }
  print("Completed Tracker Flags")
  return(inpData)  
}

checkHttpLeaks <- function(inpData) {
  print(inpData)
  lk <- grep(inpData, httpData$uri, ignore.case=TRUE, perl=TRUE)  
  lk <- c(lk, grep(inpData, httpData$post_body,ignore.case=TRUE, perl=TRUE))
  lk <- c(lk, grep(inpData, httpData$deflate_post,ignore.case=TRUE, perl=TRUE))
  lk <- unique(lk) 
  x <- rep(0, nrow(httpData))
  if(length(lk)>0)
    x[lk] <- 1
  return(x)
}

filterHttpBG <- function(inpTable) {    
  goodIPList <- c("173.194", "74.125.", "108.160.", "138.96.0.11", "195.8.214.", "195.8.215.")
  x <- c()
  for (i in 1:length(goodIPList)) {
    x <- c(x, grep(goodIPList[i], inpTable$id.orig_h))
    x <- c(x, grep(goodIPList[i], inpTable$id.resp_h))
  }  
  goodHostList <- c("mtalk.google.com", "pop3.live.com","ssuggest.com", "dropbox.com", "dailymotion.com", "youtube.com", "pool.ntp.org", "deezer.com", "samsung.com", "samsungosp.com")  
  for (i in 1:length(goodHostList)) {
    x <- c(x, grep(goodHostList[i], inpTable$host))    
  }  
  print(length(x))
  
  y <- seq(1,nrow(inpTable),1)
  y<-setdiff(y,x)
  return(inpTable[y,])
}

getApkLeakAggr <- function (inpData) {
  #httpData$androidIDLeaks + httpData$contactLeaks + httpData$emailLeaks
  #httpData$imeiLeaks + httpData$locationLeaks + httpData$loginLeaks
  #httpData$macLeaks + httpData$passwordLeaks
  #httpData$telLeaks + httpData$smsLeaks;  
  LeakAggr <- aggregate(inpData[c("anyLeaks", "androidIDLeaks", "contactLeaks", "emailLeaks", "imeiLeaks", "imsiLeaks",
                                  "locationLeaks", "loginLeaks", "macLeaks", "passwordLeaks", "telLeaks", "smsLeaks")],
                        by=list(malwareFamily=inpData$malwareFamily, apkName=inpData$apkName, 
                                pkgName=inpData$pkgName, malwareID=inpData$malwareID),
                        FUN=max)
  x <- LeakAggr;
  x$malwareFamily <- 0
  x$apkName <- 0;
  x$pkgName <-0;
  x$malwareID <-0;
  #LeakSum <- aggregate(x[c("malwareFamily", "apkName", "pkgName", "malwareID", "androidIDLeaks","imeiLeaks", "imsiLeaks", "telLeaks", "macLeaks", "contactLeaks", "smsLeaks", "emailLeaks")],
  #                     by=list(),
  #                     FUN=sum)
  #LeakAggr <- rbind(LeakSum, LeakAggr)
  LeakAggr$http_traffic_gen <- 1;
  LeakAggr <- LeakAggr[order(LeakAggr$malwareFamily, LeakAggr$malwareID, decreasing=FALSE),]
  return(LeakAggr)  
}


getFamilyLeakAggr <- function (inpData) {
  LeakAggr <- getApkLeakAggr(inpData)  
  FamilyAggr <- aggregate(LeakAggr[c("http_traffic_gen", "anyLeaks","androidIDLeaks", "contactLeaks", "emailLeaks", "imeiLeaks", "imsiLeaks",
                                    "locationLeaks", "loginLeaks", "macLeaks", "passwordLeaks", "telLeaks", "smsLeaks")],
                          by=list(malwareFamily=LeakAggr$malwareFamily),
                          FUN=sum)  
  return(FamilyAggr)
}

getHttpHostLeakAggr <- function(inpData) {
  httpAggr <- aggregate(inpData[c("num_flows")],
                        by=list(malwareFamily=inpData$malwareFamily, pkgName=inpData$pkgName, malwareID=inpData$malwareID,
                              host=inpData$host, remoteIP=inpData$remoteIP,
                              androidIDLeaks=inpData$androidIDLeaks, 
                              imeiLeaks=inpData$imeiLeaks, imsiLeaks=inpData$imsiLeaks, 
                              telLeaks=inpData$telLeak, macLeaks=inpData$macLeaks,                              
                              contactLeaks=inpData$contactLeaks, smsLeaks=inpData$smsLeaks, emailLeaks=inpData$emailLeaks),
                        FUN=sum)
  httpAggr <- httpAggr[order(httpAggr$malwareFamily, httpAggr$host, httpAggr$remoteIP, httpAggr$malwareID, decreasing=FALSE),]
  return (httpAggr)
}

filterConnBG <- function(inpTable) {    
  inpTable <- inpTable[grep("::", inpTable$remoteIP, invert=TRUE),]
  goodIPList <- c("173.194", "74.125.", "108.160.", "138.96.0.11", "195.8.214.", "195.8.215.")
  x <- c()
  for (i in 1:length(goodIPList)) {
    x <- c(x, grep(goodIPList[i], inpTable$remoteIP))
  }  
  goodHostList <- c("mtalk.google.com", "bcmls2.glpals.com","pop3.live.com","ssuggest.com", "dropbox.com", "dailymotion.com", "youtube.com", "pool.ntp.org", "deezer.com", "samsung.com", "samsungosp.com")
  for (i in 1:length(goodHostList)) {
    x <- c(x, grep(goodHostList[i], inpTable$dns_latest_fqdn))    
  } 
  samsungIpList <- c("54.246.88.", "54.246.89.", "54.228.207.", "54.247.190.", "54.247.188.", "54.228.207.",
                     "54.247.185.", "54.247.186.", "54.246.87.", "54.228.222.", "54.247.185.", "54.217.233.")
  z1 <- grep("-", inpTable$dns_latest_fqdn)
  for (i in 1:length(samsungIpList)) {
    z2 <- grep(samsungIpList[i], inpTable$remoteIP)
    x <- c(x, intersect(z1, z2))        
  }   
  print(length(x))
  y <- seq(1,nrow(inpTable),1)  
  y<-setdiff(y,x)
  inpTable <- inpTable[y,]    
  return(inpTable)  
}

assignConnTrackerFlag <- function(trackerDomains, inpData) {  
  # TODO:: Read from Database the list of trackers and assign a tracker based on httpData
  print("Assigning Tracker Flags")  
  # Assuming that number of http flows are larger than the tracker rows~3k
  trackerRows <- unique(unlist(lapply(trackerDomains,  function(x) {grep(x, inpData$dns_latest_fqdn)})))  
  trackerRows <- unique(unlist(lapply(trackerDomains,  function(x) {grep(x, inpData$dns_first_fqdn)})))    
  inpData$tracker_flag <- FALSE;
  if (length(trackerRows) > 0) { 
    inpData[trackerRows, ]$tracker_flag <- TRUE;
  }
  print("Completed Tracker Flags")
  return(inpData)  
}

filterConnGoodHosts <- function(inpTable) {      
  goodHostList <- c("google\\.com", "qq\\.com", "fbcdn.*akamai*", "weibo\\.c*", "twitter\\.com",
                    "twimg\\.com", "91\\.com", "samsungapps\\.com", "cnzz\\.com", "qiushibaike\\.com",
                    "funshion\\.com");
  x<-list()
  for (i in 1:length(goodHostList)) {
    x <- c(x, grep(goodHostList[i], inpTable$dns_latest_fqdn))    
  }  
  print(length(x))
  y <- seq(1,nrow(inpTable),1)  
  y<-setdiff(y,x)
  return(inpTable[y,])  
}

labelUnusualTraffic <- function(inpData) {   
  inpData$weirdPorts <- 0
  inpData[!(inpData$remotePort %in% c("80","443","53","8080")),]$weirdPorts <- 1
  unique(inpData[inpData$weirdPorts==1,]$remotePort)  
  unique(inpData[inpData$weirdPorts==1,]$dns_latest_fqdn)
  unique(inpData[inpData$weirdPorts==1,]$remoteIP)
  
  inpData$weirdProto <- 0
  inpData[!(inpData$proto %in% c("tcp","udp")),]$weirdProto <- 1
  unique(inpData[inpData$weirdProto==1,]$dns_latest_fqdn)
  unique(inpData[inpData$weirdProto==1,]$remoteIP)
  unique(inpData[inpData$weirdProto==1,]$proto)
  
  inpData$weirdDNS <- 0
  inpData[inpData$remotePort==53 & !(inpData$remoteIP %in% c("138.96.0.11", "138.96.0.10")),]$weirdDNS <- 1
  unique(inpData[inpData$weirdDNS==1,]$remoteIP)
  
  inpData$openSYN <- 0
  inpData[inpData$proto=="tcp" & (inpData$conn_state %in% c("S0","SH")),]$openSYN<-1
  unique(inpData[inpData$openSYN==1,]$remoteIP)
  unique(inpData[inpData$openSYN==1,]$dns_latest_fqdn)
  
  inpData$nonHttpOnHttp <- 0
  inpData[inpData$proto=="tcp" & inpData$remotePort=="80" 
          & inpData$service!="http" & !(inpData$conn_state %in% c("S0", "SH")),]$nonHttpOnHttp<-1
  unique(inpData[inpData$nonHttpOnHttp==1,]$remoteIP)
  
  inpData$connRej <- 0
  inpData[inpData$proto=="tcp" & (inpData$conn_state %in% c("REJ", "RSTR", "")),]$connRej<-1
  unique(inpData[inpData$connRej==1,]$remoteIP)
  unique(inpData[inpData$connRej==1,]$dns_latest_fqdn)
  
  return(inpData)  
}

aggregateUnusualTraffic <- function(inpData) {
  wData <- labelUnusualTraffic(inpData)
  # Aggregate per malware
  wAggr <- aggregate(wData[c("weirdProto", "weirdPorts", "weirdDNS", "openSYN", "connRej","nonHttpOnHttp")],
                     by=list(malwareFamily=wData$malwareFamily, 
                             malwareID=wData$malwareID),
                     FUN=max) 
  # Aggregate per family
  wAggr$weird_test_count <- 1;  
  wFamAggr <- aggregate(wAggr[c("weird_test_count", "weirdProto", "weirdPorts", "weirdDNS", "openSYN", "connRej","nonHttpOnHttp")],
                        by=list(malwareFamily=wAggr$malwareFamily),                               
                        FUN=sum)                    
  return (list(malwareAggr=wAggr, familyAggr=wFamAggr))
}


getDomains <- function(host) {
  domains<- unlist(lapply(host, function(x) { y<-unlist(strsplit(x,"\\."));
                                              if (length(y)>1) {
                                                if ((nchar(tail(y,1))>2) | ((y[length(y)-1])!= "co")) {
                                                  y<-tail(y,2);
                                                } else {
                                                  #print(y)
                                                  y<-tail(y,3);
                                                }
                                              }
                                              y <- paste(y,collapse=".", sep="");                                                                        
                                              return(y);  
  }))
  return(domains)
}

########################################################################
######### SUMMARY STATS ################################################
########################################################################

fName <- paste(broLogsDir, "conn.log.dns.mal.",testID, sep="")
connData <- readConnData(fName)
print(nrow(connData))
connData$remoteIP <- connData$id.resp_h
connData$remotePort <- connData$id.resp_p
connData[grep("10.11.3.", connData$id.resp_h), ]$remoteIP <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_h
connData[grep("10.11.3.", connData$id.resp_h), ]$remotePort <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_p

connData <- filterConnBG(connData)
connData$tot_bytes <- connData$orig_ip_bytes + connData$resp_ip_bytes
connData$num_flows <- 1

summConnData <- connData;
summConnData[summConnData$service=="-",]$service <- "other"
summConnData[!(summConnData$proto %in% c("tcp", "udp")),]$proto <- "other"
aggrConnData <- aggregate(summConnData[c("tot_bytes", "num_flows")],
                          by=list(proto=summConnData$proto, service=summConnData$service, 
                                  malwareID=summConnData$malwareID),
                          FUN=sum)
totConnData <- aggregate(summConnData[c("tot_bytes", "num_flows")],
                         by=list(malwareID=summConnData$malwareID),
                         FUN=sum)
colnames(totConnData) <- gsub("tot_bytes", "all_bytes", colnames(totConnData))
colnames(totConnData) <- gsub("num_flows", "all_flows", colnames(totConnData))
aggrConnData <- merge(aggrConnData, totConnData)
aggrConnData$perc_median_bytes <- 100*(aggrConnData$tot_bytes/aggrConnData$all_bytes)
aggrConnData$perc_median_flows <- 100*(aggrConnData$num_flows/aggrConnData$all_flows)
medianConnData <- aggregate(aggrConnData[c("tot_bytes", "num_flows", "perc_median_bytes", "perc_median_flows")],
                          by=list(proto=aggrConnData$proto, service=aggrConnData$service),
                          FUN=median)
colnames(medianConnData) <- gsub("tot_bytes", "median_bytes", colnames(medianConnData))
colnames(medianConnData) <- gsub("num_flows", "median_flows", colnames(medianConnData))
totConnData <- aggregate(summConnData[c("tot_bytes", "num_flows")],
                          by=list(),
                          FUN=sum)
colnames(totConnData) <- gsub("tot_bytes", "all_bytes", colnames(totConnData))
colnames(totConnData) <- gsub("num_flows", "all_flows", colnames(totConnData))
aggrConnData <- aggregate(summConnData[c("tot_bytes", "num_flows")],
                          by=list(proto=summConnData$proto, service=summConnData$service),                                  
                          FUN=sum)
aggrConnData <- merge(aggrConnData, medianConnData)
aggrConnData <- merge(aggrConnData, totConnData)
aggrConnData$perc_bytes <- 100*(aggrConnData$tot_bytes/aggrConnData$all_bytes)
aggrConnData$perc_flows <- 100*(aggrConnData$num_flows/aggrConnData$all_flows);
options(scipen="100")
write.table(aggrConnData, paste(resultsDir, "summaryTrafficStats.txt.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(aggrConnData)), row.names=FALSE, fileEncoding="utf-8")
rm(summConnData)
rm(totConnData)
rm(aggrConnData)
########################################################################
######### WEIRD FLOW STATS #############################################
########################################################################

apkMetaData <- paste(miscDir, "apkMetaData-",testID, sep="");
#timestampHeaders <- c("apkName", "pkgName", "tStart", "tStartHuman", "tStop", "tStopHuman")
apkMetaData <- read.table(apkMetaData, header=T, sep="\t", fill=FALSE, stringsAsFactors=FALSE,
                          quote="", row.names=NULL)
apkMetaData$tot_malware <- 1
malwareCounts <- aggregate(apkMetaData[c("tot_malware")],
                           by=list(family=apkMetaData$family),
                           FUN=sum)
malwareCounts$malwareFamily <- malwareCounts$family;
malwareCounts$family <- NULL


trafficGenFamilies <- getTrafficGenMalware(connData)

weirdConnData<-aggregateUnusualTraffic(connData)
wierdMalwareAggregate <- weirdConnData$malwareAggr
wierdFamilyAggregate <- weirdConnData$familyAggr
malwareCounts <- merge(malwareCounts, trafficGenFamilies, all.x=TRUE)
malwareCounts[is.na(malwareCounts)] <- 0
wierdFamilyAggregate <- merge(malwareCounts, wierdFamilyAggregate, all.x=TRUE)
wierdFamilyAggregate[is.na(wierdFamilyAggregate)] <-0

write.table(wierdFamilyAggregate, paste(resultsDir, "wierdTrafficFamilySummary.txt.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(wierdFamilyAggregate)), row.names=FALSE, fileEncoding="utf-8")
write.table(wierdMalwareAggregate, paste(resultsDir, "wierdTrafficMalwareSummary.txt.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(wierdMalwareAggregate)), row.names=FALSE, fileEncoding="utf-8")

########################################################################
######### ANALYZE LEAKS ################################################
########################################################################

# What is leaked?
imeiNumber <- "(354017052338155)|(MzU0MDE3MDUyMzM4MTU1)"
telNumber <- "(659799814)|(NjU5Nzk5ODE0)"
androidID <- "(5c8df34ec38d07fb)|(NWM4ZGYzNGVjMzhkMDdmYg==)"
imsiNumber <- "(208150003885251)|(MjA4MTUwMDAzODg1MjUx)"
macAddress <- "(38:aa:3c:b6:57:7e)|(38aa3cb6577e)|(Mzg6YWE6M2M6YjY6NTc6N2U==)"
email <- "(parikshan\\.khata)|(cGFyaWtzaGFuLmtoYXRhQGdtYWlsLmNvbQ)"
contactsRegex <- "((bubulina)|(1123581321)|(654321654)|(1122335588)|(YnVidWxpbmE)|(paritest))"
loginRegex <- "(manuallyenteredmail)|(fakeemail)|(parikshan\\.khata)"
passwordRegex <- "(manuallyenteredpassw)|(fakepassw)"
smsRegex <- "((nouvelle\ facture)|(de\ messagerie\ vocale))"
locationRegex <- "[^a-zA-Z]?((lat([^a-zA-Z]|itude))|(loc([^a-zA-Z]|ation))|(gpsx)).*[0-9]+"

fName <- paste(broLogsDir, "http.log.mal.",testID, sep="")
httpData <- readHttpData(fName)
fName <- paste(broLogsDir, "http.uncompress.",testID, sep="")
uncompress <- read.table(fName, header=T, sep="\t", quote="", 
                        comment.char="#", stringsAsFactors=FALSE)
httpData <- merge(httpData, uncompress, all.x=TRUE)
#httpData[is.na(httpData$deflate_post),]$deflate_post <- "-"

#httpData$dec_uri <- unlist(lapply(httpData$uri, function(x) { y <- URLdecode(x);  y<-enc2utf8(y); return(y)}));
httpData <- filterHttpBG(httpData)
#traffigGenApps <- unique(connData$malwareID)
# IMEI 
httpData$androidIDLeaks <- checkHttpLeaks(androidID)
httpData$contactLeaks <- checkHttpLeaks(contactsRegex)
httpData$emailLeaks <- checkHttpLeaks(email)
httpData$imeiLeaks<- checkHttpLeaks(imeiNumber)
httpData$imsiLeaks<- checkHttpLeaks(imsiNumber)
httpData$locationLeaks <- checkHttpLeaks(androidID)
httpData$loginLeaks <- checkHttpLeaks(loginRegex)
httpData$macLeaks <- checkHttpLeaks(macAddress)
httpData$passwordLeaks <- checkHttpLeaks(passwordRegex)
httpData$telLeaks <- checkHttpLeaks(telNumber)
httpData$smsLeaks <- checkHttpLeaks(smsRegex)
httpData$anyLeaks <- httpData$androidIDLeaks + httpData$contactLeaks + httpData$emailLeaks +
                     httpData$imeiLeaks + httpData$imsiLeaks + 
                     httpData$locationLeaks + httpData$loginLeaks +
                     httpData$macLeaks + httpData$passwordLeaks +
                     httpData$telLeaks + httpData$smsLeaks;  
httpData[httpData$anyLeaks>0, ]$anyLeaks <- 1;
#httpData$imsiLeaks <- checkLeaks(imsiNumber)
httpData$num_flows <- 1;
httpData$remoteIP <- httpData$id.resp_h
httpData[grep("10.11.3.", httpData$id.resp_h), ]$remoteIP <- httpData[grep("10.11.3.", httpData$id.resp_h), ]$id.orig_h
httpFamilyAggr <- getFamilyLeakAggr(httpData)
httpFamilyAggr <- merge(malwareCounts, httpFamilyAggr, all.x=TRUE)
httpFamilyAggr <- merge(httpFamilyAggr, wierdFamilyAggregate)
httpFamilyAggr[is.na(httpFamilyAggr)]<-0
write.table(httpFamilyAggr, paste(resultsDir, "leakTrafficFamilySummary.txt.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(httpFamilyAggr)), row.names=FALSE, fileEncoding="utf-8")

httpMalwareAggr <- getApkLeakAggr(httpData)
pkgMeta <- data.frame(apkName=apkMetaData$apkName, pkgName=apkMetaData$pkgName)
pkgMeta$malwareID <- seq(1, nrow(pkgMeta), 1)
wierdMalwareAggregate <- merge(pkgMeta, wierdMalwareAggregate)
httpMalwareAggr <- merge(wierdMalwareAggregate, httpMalwareAggr, all.x=TRUE)
httpMalwareAggr[is.na(httpMalwareAggr)] <- 0
httpMalwareAggr <- httpMalwareAggr[order(httpMalwareAggr$malwareFamily, httpMalwareAggr$apkName),]
write.table(httpMalwareAggr, paste(resultsDir, "leakTrafficMalwareSummary.txt.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(httpMalwareAggr)), row.names=FALSE, fileEncoding="utf-8")

########################################################################
######### TOP TRACKERS #################################################
########################################################################

trackerFile <- paste(miscDir, "trackerList.txt", sep="")
trackerTable <- read.table(trackerFile, header=T, sep="\t", quote="", 
                           comment.char="#", stringsAsFactors=FALSE)
connData <- assignConnTrackerFlag(trackerTable$domain, connData)
httpData <- assignTrackerFlag(trackerTable$domain, httpData)
httpData$num_flows <-1

httpData$domain <- getDomains(httpData$host)
trackerFlows <- httpData[(httpData$tracker_flag==TRUE)&(httpData$anyLeaks>0), ]

topHttpTrackers <- aggregate(trackerFlows[c("num_flows")],
                             by=list(domain=trackerFlows$domain, malwareID=trackerFlows$malwareID),
                             FUN=sum)
topHttpTrackers$malware_count <-1;
topHttpTrackers <- aggregate(topHttpTrackers[c("malware_count")],
                             by=list(domain=topHttpTrackers$domain),
                             FUN=sum)
topHttpTrackers <- topHttpTrackers[order(topHttpTrackers$malware_count, decreasing=TRUE),]
write.table(topHttpTrackers, paste(resultsDir, "topMalwareTrackers.txt.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(topHttpTrackers)), row.names=FALSE, fileEncoding="utf-8")


########################################################################
######### WHO ARE THE ONES THAT DID NOT LEAK ###########################
########################################################################

httpLeaking <- aggregate(httpData[c("anyLeaks")],
                         by=list(malwareID=httpData$malwareID),
                         FUN=max)
nonHttpMalware <- setdiff(unique(connData$malwareID), unique(httpData$malwareID))
notLeakingMalware <- unique(httpLeaking[httpLeaking$anyLeaks<1,]$malwareID)
notLeakingMalware <- union(nonHttpMalware, notLeakingMalware)

notLeakingConnData <- connData[connData$malwareID %in% notLeakingMalware, ]

httpUIDs <- notLeakingConnData[(notLeakingConnData$service=="http")|
                                (notLeakingConnData$remotePort %in% c(80,8080)) ,]$uid
foundHttp <- httpData[httpData$uid %in% httpUIDs,]
write.table(foundHttp, paste(resultsDir, "notLeakingMalwareHttp.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(foundHttp)), row.names=FALSE, fileEncoding="utf-8")

write.table(notLeakingConnData, paste(resultsDir, "notLeakingMalwareConn.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(notLeakingConnData)), row.names=FALSE, fileEncoding="utf-8")
########################################################################
######### WHO ARE THE ONES THAT LEAK ###########################
########################################################################

leakingMalware <- httpData[httpData$anyLeaks>0,]
leakingMalware$domain <- getDomains(leakingMalware$host)
leakingMalware$num_flows <- 1
leakAggr <- aggregate(leakingMalware[c("num_flows")],
                      by=list(malwareID=leakingMalware$malwareID, domain=leakingMalware$domain),
                      FUN=sum)

leakAggr$num_malware <- 1;
leakAggr <- aggregate(leakAggr[c("num_flows", "num_malware")],
                      by=list(domain=leakAggr$domain),
                      FUN=sum)
leakAggr <- leakAggr[order(leakAggr$num_malware, leakAggr$num_flows, decreasing=TRUE),]
write.table(leakAggr, paste(resultsDir, "malLeakingDomains.txt",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(leakAggr)), row.names=FALSE, fileEncoding="utf-8")

#################################################################################
########### MALWARE BY MALWARE ANALYSIS BASED ON FAMILY##########################
#################################################################################
fName <- paste(broLogsDir, "conn.log.dns.mal.",testID, sep="")
connData <- readConnData(fName)
print(nrow(connData))
connData$remoteIP <- connData$id.resp_h
connData$remotePort <- connData$id.resp_p
connData[grep("10.11.3.", connData$id.resp_h), ]$remoteIP <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_h
connData[grep("10.11.3.", connData$id.resp_h), ]$remotePort <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_p
connData <- filterConnBG(connData)
wierdData <- connData

wierdData$nonHttpPort80 <- 0;
wierdData[(wierdData$proto=="tcp") & (wierdData$remotePort %in% c(80,8080)) & (wierdData$service != "http"), ]$nonHttpPort80 <- 1;

wierdData$httpOtherPorts <- 0;
wierdData[(wierdData$proto=="tcp") & !(wierdData$remotePort %in% c(80,8080)) & (wierdData$service == "http"), ]$httpOtherPorts <- 1;

wierdData$wierdConnState <- 0;
wierdData[(wierdData$proto=="tcp") & (wierdData$conn_state %in% c("S0", "SH", "REJ", "RSTOS0", "RSTRH")), ]$wierdConnState <- 1;



unusualAggr <- aggregate(connData[c("num_flows")],
                      by=list(malwareID=leakingMalware$malwareID, domain=leakingMalware$domain),
                      FUN=sum)
########################################################################
######### SEE USER TRAFFIC FOR WEIRD BEHAVIOR ##########################
########################################################################

# See how common is the weird behavior. 
source(paste("../parsing-scripts/readLogFiles.R", sep=""))
connData <- readConnData("conn.log.info")

wData <- connData[connData$proto=="tcp",]
wData$remoteIP <- wData$id.resp_h
wData$remotePort <- wData$id.resp_p
reqRows<-(wData$id.orig_p < 2000))
wData[reqRows, ]$remoteIP <- wData[reqRows, ]$id.orig_h
wData[reqRows, ]$remotePort <- wData[reqRows, ]$id.orig_p
wData$tot_flows <- 1;


wAggr <- aggregate(wData[c("tot_flows")],
                   by=list(remotePort=wData$remotePort),
                   FUN=sum)
wAggr <- wAggr[order(wAggr$tot_flows, decreasing=TRUE),]


#wData$weirdPorts <- 0
#wData[!(wData$remotePort %in% c("80","443","53","8080", "5228", "5223", "5222", "7275", "7276", "8883", "82",
#                                "993", "1227", "1237", "995", "5900", "5901")),]$weirdPorts <- 1
#wData[abs(wData$id.orig_p-wData$id.resp_p) < 10, ]$weirdPorts <- 0

wData$openSYN <- 0
wData[wData$proto=="tcp" & (wData$conn_state %in% c("S0","SH")),]$openSYN<-1
  
wData$nonHttpOnHttp <- 0
wData[wData$proto=="tcp" & wData$remotePort=="80" 
        & wData$service!="http" & !(wData$conn_state %in% c("S0", "SH")),]$nonHttpOnHttp<-1
  
wData$connRej <- 0
wData[wData$proto=="tcp" & (wData$conn_state %in% c("REJ", "RSTR", "")),]$connRej<-1  
# Aggregate per malware

wAggr <- aggregate(wData[c("openSYN", "connRej","nonHttpOnHttp", "tot_flows")],
                   by=list(operating_system=wData$operating_system),
                   FUN=sum) 
write.table(wAggr, paste("wierdFlowCount.txt", sep=""), sep="\t", 
            quote=F, col.names=c(colnames(wAggr)), row.names=FALSE, fileEncoding="utf-8")


########################################################################
######### GET SIGNATURE ELEMENTS ########################################
########################################################################
source(paste(scriptsDir, "readLogFiles.R", sep=""))
fName <- paste(broLogsDir, "http.log.mal.",testID, sep="")
httpData <- readHttpData(fName)
httpData <- filterHttpBG(httpData)

uriParse <- getHttpParams(httpData$uri)
httpData$uriPage <- uriParse$page
httpData$uriParamNames <- uriParse$paramNames
httpData$uriParamValues <- uriParse$paramValues

httpData$num_flows <- 1
aggrPageParams <- aggregate(httpData[c("num_flows")],
                           by=list(malwareID=httpData$malwareID, 
                                   method=httpData$method, 
                                   uriPage=httpData$uriPage,
                                   uriParamNames=httpData$uriParamNames),
                           FUN=sum)
aggrPageParams <- aggrPageParams[order(aggrPageParams$malwareID, decreasing=FALSE),]
write.table(aggrPageParams, paste(resultsDir, "pageParams.mal.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(aggrPageParams)), row.names=FALSE, fileEncoding="utf-8")


aggrPageParams$num_sig_components <- 1
aggrPageParamsCnt <- aggregate(aggrPageParams[c("num_flows", "num_sig_components")],
                            by=list(malwareID=aggrPageParams$malwareID),                                    
                            FUN=sum)
write.table(aggrPageParamsCnt, paste(resultsDir, "pageParamsCnt.mal.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(aggrPageParamsCnt)), row.names=FALSE, fileEncoding="utf-8")
require(Rlibstree)
aggrPageParams






#################################################################################
#################################################################################
#################################################################################
similarityMatrices <- computeDistanceMatrix(httpData$method, httpData$uriPage, 
                                            httpData$uriParamNames, httpData$uriParamValues)
methodDistance <- similarityMatrices$methodMatrix
pageDistance <- similarityMatrices$pageMatrix
nameDistance <- similarityMatrices$nameMatrix
valueDistance <- similarityMatrices$valueMatrix
save(methodDistance, file=paste(broLogsDir, "method.distance.http.mal", testID, sep=""), compress="xz")
save(pageDistance, file=paste(broLogsDir, "page.distance.http.mal", testID, sep=""), compress="xz")     
save(nameDistance, file=paste(broLogsDir, "name.distance.http.mal", testID, sep=""), compress="xz")     
save(valueDistance, file=paste(broLogsDir, "value.distance.http.mal", testID, sep=""), compress="xz") 

distanceMatrix <- wx[1]*methodDistance + wx[2]*pageDistance + wx[3]*nameDistance+wx[4]*valueDistance

########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
######### OTHER CODE FOR ANALYSIS ######################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################
########################################################################


########## FIRST LOOK AT LEAKS CONSIDERING ADS
# Aggregate the leak results based on the package name and malware ID
httpData$num_flows <- 1;
LeakAggr <- getApkLeakAggr(httpData)
write.table(LeakAggr, paste(resultsDir, "ApkHttpLeakSummary.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(LeakAggr)), row.names=FALSE, fileEncoding="utf-8")

httpAggr <- getHttpHostLeakAggr(httpData)
write.table(httpAggr, paste(resultsDir, "httpHostLeakSummary.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(httpAggr)), row.names=FALSE, fileEncoding="utf-8")

############ NOW LOOK AT LEAKS WITHOUT ADS AND OTHER TRACKERS
#trackerFile <- paste(miscDir, "trackerList.txt", sep="")
#trackerTable <- read.table(trackerFile, header=T, sep="\t", quote="", 
#                           comment.char="#", stringsAsFactors=FALSE)
#httpData <- assignTrackerFlag(trackerTable$domain, httpData)
#trackerFreeHttpData <- httpData[httpData$tracker_flag==FALSE, ] 

#LeakAggr <- getApkLeakAggr(trackerFreeHttpData)
#write.table(LeakAggr, paste(resultsDir, "TrackerFreeApkHttpLeakSummary.",testID, sep=""), sep="\t", 
#           quote=F, col.names=c(colnames(LeakAggr)), row.names=FALSE, fileEncoding="utf-8")

#httpAggr <- getHttpHostLeakAggr(trackerFreeHttpData)
#write.table(httpAggr, paste(resultsDir, "TrackerFreeHttpHostLeakSummary.",testID, sep=""), sep="\t", 
#            quote=F, col.names=c(colnames(httpAggr)), row.names=FALSE, fileEncoding="utf-8")

#################################################################################################
################ FAMILY BASED GROUPING OF DATA ##################################################
#################################################################################################

fName <- paste(broLogsDir, "conn.log.dns.mal.",testID, sep="")
connData <- readConnData(fName)
print(nrow(connData))
connData$remoteIP <- connData$id.resp_h
connData$remotePort <- connData$id.resp_p
connData[grep("10.11.3.", connData$id.resp_h), ]$remoteIP <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_h
connData[grep("10.11.3.", connData$id.resp_h), ]$remotePort <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_p

connData <- filterConnBG(connData)
#x <- filterConnBG(connData)
#x <- x[x$dns_latest_fqdn=="-",]
#y <- data.frame(unique(x$remoteIP))

connData$tot_bytes <- connData$orig_ip_bytes + connData$resp_ip_bytes;
connData$num_flows <- 1;

apkMetaData <- paste(miscDir, "apkMetaData-",testID, sep="");
#timestampHeaders <- c("apkName", "pkgName", "tStart", "tStartHuman", "tStop", "tStopHuman")
apkMetaData <- read.table(apkMetaData, header=T, sep="\t", fill=FALSE, stringsAsFactors=FALSE,
                          quote="", row.names=NULL)
apkMetaData$count <- 1
malwareCounts <- aggregate(apkMetaData[c("count")],
                           by=list(family=apkMetaData$family),
                           FUN=sum)
malwareCounts$malwareFamily <- malwareCounts$family
malwareCounts$family <- NULL;

connData$num_flows <- 1;
connTraffic <- aggregate(connData[c("num_flows")],
                         by=list(malwareFamily=connData$malwareFamily, malwareID=connData$malwareID),
                         FUN=sum)
connTraffic$genTraffic <- 1
connTraffic <- aggregate(connTraffic[c("genTraffic")],
                         by=list(malwareFamily=connTraffic$malwareFamily),
                         FUN=sum)
malwareCounts <- merge(malwareCounts, connTraffic, all.x=TRUE)
familyAggr <- getFamilyLeakAggr(httpData)
malwareCounts <- merge(malwareCounts, familyAggr, all.x=TRUE)







#################################################################################
#################################################################################
#################################################################################
source(paste(scriptsDir, "readLogFiles.R", sep=""))
fName <- paste(broLogsDir, "http.log.mal.",testID, sep="")
httpData <- readHttpData(fName)

uriParse <- getHttpParams(httpData$uri)
httpData$uriPage <- uriParse$page
httpData$uriParamNames <- uriParse$paramNames
httpData$uriParamValues <- uriParse$paramValues

trackerTable <- loadTrackerTable(namedTrackerFile)
httpData <- assignTrackerFlag(trackerTable$domain, httpData)
trackerFreeHttpData <- httpData[httpData$trackerFlag==FALSE, ] 

similarityMatrices <- computeDistanceMatrix(httpData$method, httpData$uriPage, 
                                            httpData$uriParamNames, httpData$uriParamValues)
methodSimilarityMatrix <- similarityMatrices$methodMatrix
pageSimilarityMatrix <- similarityMatrices$pageMatrix
nameSimilarityMatrix <- similarityMatrices$nameMatrix
valueSimilarityMatrix <- similarityMatrices$valueMatrix
save(methodSimilarityMatrix, file=paste(broLogsDir, "method.similarity.http.mal", testID, sep=""), compress="xz")
save(pageSimilarityMatrix, file=paste(broLogsDir, "page.similarity.http.mal", testID, sep=""), compress="xz")     
save(nameSimilarityMatrix, file=paste(broLogsDir, "name.similarity.http.mal", testID, sep=""), compress="xz")     
save(valueSimilarityMatrix, file=paste(broLogsDir, "value.similarity.http.mal", testID, sep=""), compress="xz")     

#####################################################################################
#####################################################################################
############# LOOK AT THE CONNECTIONS ###############################################
#####################################################################################
#####################################################################################

### Filter the connData to get the required number of flows, 
fName <- paste(broLogsDir, "conn.log.dns.mal.",testID, sep="")
connData <- readConnData(fName)
print(nrow(connData))

connData <- filterConnBG(connData)

connData$remoteIP <- connData$id.resp_h
connData$remotePort <- connData$id.resp_p
connData[grep("10.11.3.", connData$id.resp_h), ]$remoteIP <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_h
connData[grep("10.11.3.", connData$id.resp_h), ]$remotePort <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_p
connData <- connData[grep("::", connData$remoteIP, invert=TRUE),]
connData$tot_bytes <- connData$orig_ip_bytes + connData$resp_ip_bytes;
connData$num_flows <- 1;

connAggr <- aggregate(connData[c("num_flows", "orig_ip_bytes", "resp_ip_bytes", "tot_bytes")],
                      by=list(malwareFamily=connData$malwareFamily, pkgName=connData$pkgName, malwareID=connData$malwareID, 
                              remoteIP=connData$remoteIP, remotePort=connData$remotePort,
                              dns_latest_fqdn=connData$dns_latest_fqdn,
                              proto=connData$proto, service=connData$service),
                      FUN=sum)

connAggr <- connAggr[order(connAggr$malwareFamily, connAggr$dns_latest_fqdn, connAggr$remoteIP, malwareID=connAggr$malwareID, connAggr$tot_bytes, decreasing=FALSE),]
write.table(connAggr, paste(resultsDir, "connSummary.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(connAggr)), row.names=FALSE, fileEncoding="utf-8")


trackerFile <- paste(miscDir, "trackerList.txt", sep="")
trackerTable <- read.table(trackerFile, header=T, sep="\t", quote="", 
                           comment.char="#", stringsAsFactors=FALSE)
connData <- assignConnTrackerFlag(trackerTable$domain, connData)
#trackerFreeConnData <- connData[connData$tracker_flag==FALSE, ] 
#trackerFreeGoodConnData <- filterConnGoodHosts(trackerFreeConnData)

noHostConnData <-connData[connData$dns_latest_fqdn=="-",]

connAggr <- aggregate(noHostConnData[c("num_flows", "orig_ip_bytes", "resp_ip_bytes", "tot_bytes")],
                      by=list(malwareFamily=noHostConnData$malwareFamily, 
                              pkgName=noHostConnData$pkgName, 
                              malwareID=noHostConnData$malwareID, 
                              remoteIP=noHostConnData$remoteIP, 
                              remotePort=noHostConnData$remotePort,
                              dns_latest_fqdn=noHostConnData$dns_latest_fqdn,
                              proto=noHostConnData$proto, service=noHostConnData$service),
                      FUN=sum)

connAggr <- connAggr[order(connAggr$malwareFamily, connAggr$dns_latest_fqdn, connAggr$remoteIP, malwareID=connAggr$malwareID, connAggr$tot_bytes, decreasing=FALSE),]
write.table(connAggr, paste(resultsDir, "noHostConnSummary.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(connAggr)), row.names=FALSE, fileEncoding="utf-8")



# httpData[imeiLeaks, ]$malwareID
# unique(httpData[telLeaks, ]$malwareID)
# unique(httpData[imsiLeaks, ]$malwareID)
# unique(httpData[contactLeaks, ]$malwareID)
                      
# httpData$anyLeak <- httpData$androidIDLeaks + httpData$contactLeaks + httpData$emailLeaks
#                     httpData$imeiLeaks + httpData$locationLeaks + httpData$loginLeaks
#                     httpData$macLeaks + httpData$passwordLeaks
#                     httpData$telLeaks + httpData$smsLeaks;

# y<-x$post_body
# Encoding(y)<-"bytes"
# z <- charToRaw(y)
# 
# a <- "a string"
# b <- gzip(a)
                      
