baseDir<-"/user/arao/home/controlled_experiments/malware_tests/"
scriptsDir<-paste(baseDir, "/parsing-scripts/", sep="")
broLogsDir<-paste(baseDir, "/bro-results/malware-test/", sep="")
miscDir<-paste(baseDir, "/miscData/", sep="")
testID <- "dave-manual-1";
setwd(scriptsDir);

source(paste(scriptsDir, "readLogFiles.R", sep=""))
fName <- paste(broLogsDir, "http.log", sep="");
httpData <- readHttpData(fName)
fName <- paste(broLogsDir, "conn.log", sep="");
connData <- readConnData(fName)
fName <- paste(broLogsDir, "ssl.log", sep="");
sslData <- readSslData(fName)
fName <- paste(broLogsDir, "dns.log", sep="");
dnsData <- readHttpData(fName)

apkMetaData <- paste(miscDir, "apkMetaData-",testID, sep="");
#timestampHeaders <- c("apkName", "pkgName", "tStart", "tStartHuman", "tStop", "tStopHuman")
apkMetaData <- read.table(apkMetaData, header=T, sep="\t", fill=FALSE, stringsAsFactors=FALSE,
                            quote="", row.names=NULL)
apkMetaData$tStart <- as.numeric(apkMetaData$tStart)
apkMetaData$tStop <- as.numeric(apkMetaData$tStop)

addColumns <- function(inpData) {
  inpData$apkName <- "-"
  inpData$pkgName <- "-"
  inpData$malwareID <- 0
  inpData$malwareFamily <- "-"  
  return(inpData)
}

labelMalware<-function(inpData, i) {
  reqRows <- which((inpData$ts>= apkMetaData[i,]$tStart) & (inpData$ts <= apkMetaData[i,]$tStop))
  if (length(reqRows) > 0) {
    inpData[reqRows,]$malwareID <- i;
    inpData[reqRows,]$apkName <- apkMetaData[i,]$apkName
    inpData[reqRows,]$pkgName <- apkMetaData[i,]$pkgName
    inpData[reqRows,]$malwareFamily <- apkMetaData[i,]$family
  }  
  return(inpData)
}

httpData <- addColumns(httpData)
connData <- addColumns(connData)
sslData <- addColumns(sslData)
dnsData <- addColumns(dnsData)


colnames(apkMetaData)
for (i in 1:nrow(apkMetaData)) {
  print(i)
  sslData <- labelMalware(sslData, i)
  connData <- labelMalware(connData,i)
  httpData <- labelMalware(httpData, i)
  dnsData <- labelMalware(dnsData,i)
}

httpData<-httpData[httpData$malwareID >0, ]
sslData<-sslData[sslData$malwareID >0, ]
connData<-connData[connData$malwareID >0, ]
dnsData<-dnsData[dnsData$malwareID >0, ]

write.table(httpData, paste(broLogsDir, "http.log.mal.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(httpData)), row.names=FALSE, fileEncoding="utf-8")
write.table(sslData, paste(broLogsDir, "ssl.log.mal.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(sslData)), row.names=FALSE, fileEncoding="utf-8")
write.table(connData, paste(broLogsDir, "conn.log.mal.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(connData)), row.names=FALSE, fileEncoding="utf-8")
write.table(dnsData, paste(broLogsDir, "dns.log.mal.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(dnsData)), row.names=FALSE, fileEncoding="utf-8")