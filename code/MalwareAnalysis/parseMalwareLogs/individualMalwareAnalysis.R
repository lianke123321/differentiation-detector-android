baseDir<-"/home/arao/proj-work/meddle/projects/meddle_malware_data/"
#baseDir<-"/user/arao/home/controlled_experiments/malware_tests/loge/meddle_malware_data/"
scriptsDir<-paste(baseDir, "/parsing-scripts/", sep="")
broLogsDir<-paste(baseDir, "/bro-results/malware-test/", sep="")
miscDir<-paste(baseDir, "/miscData/", sep="")
resultsDir<-paste(baseDir, "/results/", sep="")
testID <- "dave-manual-1";
setwd(scriptsDir);

source(paste(scriptsDir, "readLogFiles.R", sep=""))

filterHttpBG <- function(inpTable) {    
  goodIPList <- c("173.194", "74.125.", "108.160.", "138.96.0.11", "195.8.214.", "195.8.215.")
  x <- c()
  for (i in 1:length(goodIPList)) {
    x <- c(x, grep(goodIPList[i], inpTable$id.orig_h))
    x <- c(x, grep(goodIPList[i], inpTable$id.resp_h))
  }  
  goodHostList <- c("mtalk.google.com", "pop3.live.com","ssuggest.com", "dropbox.com", "dailymotion.com", "youtube.com", "pool.ntp.org", "deezer.com", "samsung.com", "samsungosp.com")  
  for (i in 1:length(goodHostList)) {
    x <- c(x, grep(goodHostList[i], inpTable$host))    
  }  
  print(length(x))
  
  y <- seq(1,nrow(inpTable),1)
  y<-setdiff(y,x)
  return(inpTable[y,])
}

filterConnBG <- function(inpTable) {    
  inpTable <- inpTable[grep("::", inpTable$remoteIP, invert=TRUE),]
  goodIPList <- c("173.194", "74.125.", "108.160.", "138.96.0.11", "195.8.214.", "195.8.215.")
  x <- c()
  for (i in 1:length(goodIPList)) {
    x <- c(x, grep(goodIPList[i], inpTable$remoteIP))
  }  
  goodHostList <- c("mtalk.google.com", "bcmls2.glpals.com","pop3.live.com","ssuggest.com", "dropbox.com", "dailymotion.com", "youtube.com", "pool.ntp.org", "deezer.com", "samsung.com", "samsungosp.com")
  for (i in 1:length(goodHostList)) {
    x <- c(x, grep(goodHostList[i], inpTable$dns_latest_fqdn))    
  } 
  samsungIpList <- c("54.246.88.", "54.246.89.", "54.228.207.", "54.247.190.", "54.247.188.", "54.228.207.",
                     "54.247.185.", "54.247.186.", "54.246.87.", "54.228.222.", "54.247.185.", "54.217.233.")
  z1 <- grep("-", inpTable$dns_latest_fqdn)
  for (i in 1:length(samsungIpList)) {
    z2 <- grep(samsungIpList[i], inpTable$remoteIP)
    x <- c(x, intersect(z1, z2))        
  }   
  print(length(x))
  y <- seq(1,nrow(inpTable),1)  
  y<-setdiff(y,x)
  inpTable <- inpTable[y,]    
  return(inpTable)  
}

getHttpParams <- function(uri) {
  #uri <- /cooguogw/list2.action?appCount=0&requestId=2"
  pageList <- rep(0, length(uri))
  paramNameList <- rep(0, length(uri))
  paramValueList <- rep(0, length(uri))
  for (i in 1:length(uri)) {
    splitURI <- unlist(strsplit(uri[i],"?", fixed=TRUE))  
    page <- splitURI[1]
    paramNames <- ""
    paramValues <- ""       
    if (length(splitURI)>1) {
      params <- splitURI[2]
      splitParams <- unlist(strsplit(params, "&", fixed=TRUE))
      for(j in 1:length(splitParams)) {
        x <- splitParams[j]
        x <- unlist(strsplit(x, "=", fixed=TRUE))
        if (length(x)>=2) {
          paramNames <- paste(paramNames,x[1],sep=",")          
          #paramNames <- paramNames.append(x[1])
          paramValues <- paste(paramValues, paste(x[2:length(x)], collapse=""), sep=",")
          #paramValues <- paramValues.append(paste(x[2:length(x)], collapse=""))
        }    
      }   
    }
    pageList[i] <- page;
    paramNameList[i] <- paramNames
    paramValueList[i] <- paramValues
  }
  return (list(page=pageList, paramNames=paramNameList, paramValues=paramValueList))
}

getDomains <- function(host) {
  domains<- unlist(lapply(host, function(x) { y<-unlist(strsplit(x,"\\."));
                                              if (length(y)>1) {
                                                if ((nchar(tail(y,1))>2) | ((y[length(y)-1])!= "co")) {
                                                  y<-tail(y,2);
                                                } else {
                                                  #print(y)
                                                  y<-tail(y,3);
                                                }
                                              }
                                              y <- paste(y,collapse=".", sep="");                                                                        
                                              return(y);  
  }))
  return(domains)
}

#################################################################################
########### MALWARE BY MALWARE ANALYSIS BASED ON FAMILY##########################
#################################################################################

fName <- paste(broLogsDir, "http.log.mal.",testID, sep="")
httpData <- readHttpData(fName)
httpData <- filterHttpBG(httpData)
httpData$num_flows <- 1
#httpData$tot_bytes <- httpData$orig_ip_bytes + httpData$resp_ip_bytes
httpData$domain <- getDomains(httpData$host)

fName <- paste(broLogsDir, "conn.log.dns.mal.",testID, sep="")
connData <- readConnData(fName)
connData$remoteIP <- connData$id.resp_h
connData$remotePort <- connData$id.resp_p
connData[grep("10.11.3.", connData$id.resp_h), ]$remoteIP <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_h
connData[grep("10.11.3.", connData$id.resp_h), ]$remotePort <- connData[grep("10.11.3.", connData$id.resp_h), ]$id.orig_p
connData <- filterConnBG(connData)
connData$num_flows <- 1
connData$tot_bytes <- connData$orig_ip_bytes + connData$resp_ip_bytes


malwareFamilies <- unique(connData$malwareFamily)
malwareFamilies <- malwareFamilies[order(malwareFamilies, decreasing=FALSE)]

#################################################################################
## FAMILY 1 to 40 do for each value of i
i<-40
malHttp <- httpData[httpData$malwareFamily==malwareFamilies[i],]
malConn <- connData[connData$malwareFamily==malwareFamilies[i],]
print(paste(malwareFamilies[i], length(unique(malConn$malwareID))))
malHttpAggr <- aggregate(malHttp[c("num_flows")],
                         by=list(domain=malHttp$domain, malwareID=malHttp$malwareID),
                         FUN=sum)
malHttpAggr$num_malware <- 1;
malHttpAggr <- aggregate(malHttpAggr[c("num_flows", "num_malware")],
                         by=list(domain=malHttpAggr$domain),
                         FUN=sum)
malHttpAggr <- malHttpAggr[order(malHttpAggr$num_flows, decreasing=TRUE),]


malConnAggr <- aggregate(malConn[c("num_flows")],
                         by=list(remoteIP=malConn$remoteIP, 
                                 remotePort=malConn$remotePort, 
                                 malwareID=malConn$malwareID),
                         FUN=sum)
malConnAggr$num_malware <- 1;
malConnAggr <- aggregate(malConnAggr[c("num_flows", "num_malware")],
                         by=list(remoteIP=malConnAggr$remoteIP, remotePort=malConnAggr$remotePort),
                         FUN=sum)
malConnAggr <- malConnAggr[order(malConnAggr$num_flows, decreasing=TRUE),]



#################################################################################
## Most Popular domains

malHttp <- httpData
malHttpAggr <- aggregate(malHttp[c("num_flows")],
                         by=list(domain=malHttp$domain, malwareID=malHttp$malwareID,
                                 malwareFamily=malHttp$malwareFamily),
                         FUN=sum)
malHttpAggr$num_malware <- 1;
malHttpAggr <- aggregate(malHttpAggr[c("num_flows", "num_malware")],
                         by=list(domain=malHttpAggr$domain, malwareFamily=malHttpAggr$malwareFamily),
                         FUN=sum)
malHttpAggr <- malHttpAggr[order(malHttpAggr$malwareFamily, -(malHttpAggr$num_malware), -(malHttpAggr$num_flows), decreasing=FALSE),]
write.table(malHttpAggr, paste(resultsDir, "malHttpDomainsByFamily.txt.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(malHttpAggr)), row.names=FALSE, fileEncoding="utf-8")



malHttpAggr <- aggregate(malHttp[c("num_flows")],
                         by=list(domain=malHttp$domain, malwareID=malHttp$malwareID),
                         FUN=sum)
malHttpAggr$num_malware <- 1;
malHttpAggr <- aggregate(malHttpAggr[c("num_flows", "num_malware")],
                         by=list(domain=malHttpAggr$domain),
                         FUN=sum)
malHttpAggr <- malHttpAggr[order(malHttpAggr$num_malware, malHttpAggr$num_flows, decreasing=TRUE),]
write.table(malHttpAggr, paste(resultsDir, "malHttpDomains.txt.",testID, sep=""), sep="\t", 
            quote=F, col.names=c(colnames(malHttpAggr)), row.names=FALSE, fileEncoding="utf-8")
