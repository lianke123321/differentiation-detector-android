# Functions to read the log files and convert the 

measurementStartTime <- 1351727700
# Nov 1 2012

# For this tree
#baseDir<-"/user/arao/home/china_meddle_data/"

convertStringColsToDouble <- function (stringCol) {
  stringCol <- as.double(stringCol)
  stringCol[is.na(stringCol)] <-0;
  stringCol;
}

readConnData <- function(fName, filterTs=FALSE) {
  print(paste("Reading file name", fName))
  connData <- read.table(fName, header=T, sep="\t", fill=TRUE, stringsAsFactors=FALSE, quote="", row.names=NULL);
  connData$orig_ip_bytes <- convertStringColsToDouble(connData$orig_ip_bytes);
  connData$resp_ip_bytes <- convertStringColsToDouble(connData$resp_ip_bytes);
  connData$orig_pkts <- convertStringColsToDouble(connData$orig_pkts);
  connData$resp_pkts <- convertStringColsToDouble(connData$resp_pkts);
  connData$resp_pkts <- convertStringColsToDouble(connData$resp_pkts);
  connData$duration <- convertStringColsToDouble(connData$duration);
  connData$ts <- convertStringColsToDouble(connData$ts);  
  connData$ack_time <- convertStringColsToDouble (connData$ack_time)
  connData$synack_time <- convertStringColsToDouble (connData$synack_time)
  if (filterTs==TRUE) {
      connData <- connData[connData$ts > measurementStartTime, ]
  }
  print("Done")
  # For consistency of SSL traffic and labeling.    
  connData;
}

readHttpData <- function(fName, filterTs=FALSE) {
  print(paste("Reading file name", fName))
  httpData <- read.table(fName, header=T, sep="\t", fill=TRUE, stringsAsFactors=FALSE, quote="", row.names=NULL);
  httpData$content_length <- convertStringColsToDouble(httpData$content_length)
  httpData$response_body_len <- convertStringColsToDouble(httpData$response_body_len)
  httpData$request_body_len <- convertStringColsToDouble(httpData$request_body_len)
  httpData$ts <- convertStringColsToDouble(httpData$ts);  
  if (filterTs==TRUE) {
       httpData<-httpData[httpData$ts > measurementStartTime, ]
  }
  print("Done")
  httpData
}

readSslData <- function(fName, filterTs=FALSE) {
  print(paste("Reading file name", fName))
  sslData <- read.table(fName, header=T, sep="\t", fill=TRUE, stringsAsFactors=FALSE, quote="", row.names=NULL)
  # Todo add stuff here!
  sslData$ts <- convertStringColsToDouble(sslData$ts);  
  if (filterTs ==TRUE) {
     sslData<-sslData[sslData$ts>measurementStartTime, ]
  }
  print("Done")
  sslData
}

readTable <- function(fName) {
  print(paste("Reading file name", fName))
  tableData <- read.table(fName, header=T, sep="\t", fill=TRUE, stringsAsFactors=FALSE, quote="", row.names=NULL);
  print("Done")
  tableData
}

#assumes connData is available
labelProtoService <- function() {
  # Remove the ones with unknowns
  connData <- connData[connData$isp_id!=-1, ]
  print("Processing Meta")
  # POST PROCESSING BASED ON PORT VALUES   
  connData[(connData$proto=="tcp" 
            & (connData$id.resp_p==443 | connData$id.resp_p==5228 | connData$id.resp_p == 5900 |
                 connData$id.resp_p== 8883 | connData$id.resp_p==5222 |  
                 connData$id.resp_p == 1237 | connData$id.resp_p == 993 | 
                 connData$id.resp_p == 995| connData$id.resp_p == 7275)),]$service = "ssl"
  
  connData[(connData$proto=="tcp" 
            & (connData$id.orig_p == 443 | connData$id.orig_p == 5228 | connData$id.orig_p == 5900 |
                 connData$id.orig_p == 8883 | connData$id.orig_p ==5222 | 
                 connData$id.orig_p == 1237 | connData$id.orig_p == 993 | 
                 connData$id.orig_p == 995 | connData$id.orig_p == 7275)),]$service = "ssl"
  
  #TODO:: What about VNC??      
  connData[(connData$proto=="tcp")
           &(connData$id.resp_p==5223|connData$id.orig_p==5223 |
               connData$id.orig_p == 443) 
           & (connData$operating_system=="i"),]$service="ssl"   
  # added 443 to ensure that this command does not return error
  connData[(connData$proto=="udp")&((connData$id.orig_p ==53) | (connData$id.resp_p==53)), ]$service <- "dns"
  # 5228 gtalk android
  # 8882 mqtt ssl 
  connData[(connData$proto=="tcp" & (connData$id.orig_p == 80 | connData$id.resp_p == 80 )),]$service = "http"
  
  connData[((connData$proto == "tcp") & (connData$service != "http") & (connData$service != "ssl")),]$service="other"
  connData[((connData$proto == "udp") & (connData$service != "dns")),]$service="other" 
  connData[((connData$proto != "tcp") & (connData$proto != "udp")),]$proto="other"   
  connData[(connData$proto == "other"),]$service="other"
  
  connData$tot_pkts <- connData$orig_pkts+connData$resp_pkts
  connData$tot_bytes <- connData$orig_ip_bytes + connData$resp_ip_bytes  
  connData
}
