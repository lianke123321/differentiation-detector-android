# Export all the variables
export MEDDLE_ROOT=/opt/meddle/
export MEDDLE_BRO_HOME=${MEDDLE_ROOT}/bro/

# Extract bro files from tarball and compile 
tar -xzvf bro-2.1.tar.gz
cd bro-2.1
./configure --prefix=${MEDDLE_BRO_HOME}
make
make install

# Once the compilation is done, remove the folder that keeps the temporary logs. This is required to make sure we can mount it as ramfs
# Ramfs is required to ensure that if a log file is stored on disk then it is encrypted.
rm -Rf ${MEDDLE_BRO_HOME}/spool
mkdir -p ${MEDDLE_BRO_HOME}/spool

# Ramfs step. This is required to ensure that the logs are written to ram (fast) and unencrypted logs are not stored on disk. 
# Note change the RAM size based on requirements
mount -t ramfs -o size=64m ramfs ${MEDDLE_BRO_HOME}/spool/

# Copy the files to encrypt in the binary folder. 
cp -v ${MEDDLE_BRO_HOME}/share/broctl/scripts/archive-log ${MEDDLE_BRO_HOME}/share/broctl/scripts/archive-log.old
cp -vf archive-log ${MEDDLE_BRO_HOME}/share/broctl/scripts/
cp -vf logencryptor.sh ${MEDDLE_BRO_HOME}/bin/
cp -vf AssignSignatures.R ${MEDDLE_BRO_HOME}/bin/

#Check the path in broctl.cfg for the variables CfgDir, SpoolDir, LogDir, meddleconfig, logencryptor
cp -vf ${MEDDLE_BRO_HOME}/etc/broctl.cfg ${MEDDLE_BRO_HOME}/etc/broctl.cfg.old
cp -vf broctl.cfg ${MEDDLE_BRO_HOME}/etc/broctl.cfg

# Set the log rotation interval to desired value -- change from 120 seconds to 3600 second

# Copy the custom scripts to misc
cp -vf custom-scripts/* ${MEDDLE_BRO_HOME}/share/bro/policy/misc/

#Edit ${MEDDLE_BRO_HOME}/etc/node.cfg to scan interface tun0. Have a look at node.cfg as an example
cat node.cfg 

# http://www.bro.org/documentation/broctl.broctl.html#stand-alone-bro
# Added the following line to the cron entry
0-59/5 * * * * /opt/meddle/bro/bin/broctl cron


# Take a diff of local.bro and ${MEDDLE_BRO_HOME}/share/bro/site/local.bro
# Add the appropriate lines that have the comment Arao around them

# Start broctl
${MEDDLE_BRO_HOME}/bin/broctl

# Enter install
>install
# Check
>check
# Scripts
>scripts
# Start
>start

# For Assigning Signatures
sudo apt-get install r-base-core r-cran-rmysql
