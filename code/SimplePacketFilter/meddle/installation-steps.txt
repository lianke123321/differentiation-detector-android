This file shall guide you through the installation process. If you are
stuck in any step of this installation process or you observe some
errors please contact ashwin.rao@inria.fr. 

The main configuration file is present in MeddleSystem/meddle.config
The variable MEDDLE_ROOT in the MeddleSystem/meddle.config specifies
the folder in which all the Meddle related files shall be installed.
MEDDLE_ROOT is /opt/meddle/ by default. The following steps shall
guide you in installing Meddle in the MEDDLE_ROOT folder .

1 Edit MeddleSystem/meddle.config
  - This file contains the configuration parameters for the Meddle
    system. The following fields must be edited before you begin the
    installation
       MEDDLE_ROOT - The location where all the meddle related files
              are to be placed. The default location is
              /opt/meddle. Please change this to a folder that is
              present on a drive with sufficient disk space for the
              pcap files.
      dbPassword - The password to access the database. The default
              password is meddle. There is no private information
              saved in the database so a weak password like meddle may
              not create issues. Step 3 shall guide you on installing
              the database schema. Make sure that the dbPassword 
              DOES NOT contain a # because a # is considerd to be start
              of a comment. 
      ethDeviceName - The interface used by this machine to access the
              Internet. Typically it is "eth0"
      ethIpGateway - The IP address of the gateway. This can be
              obtained by looking the default gateway provided by the
              command
                 route -n
              NOTE: The gateway is important because if this field is 
              incorrect the machine shall end up as unreachable! 
      ethIpNetSlash - The network in the / format. You can obtain this
              value with the help of the route and ifconfig commands.
      fltrDefaultDNS - The IP address of the DNS server. This can be
              one of the nameservers present in the
              /etc/resolv.conf. Please make sure that this nameserver
              is running.
      fltrAdBlockDNS - The IP address where the DNS server running the
              rules for adblocking is present. Step 4 shall guide you
              in installing a DNS server with ad blocking rules.
      webServerHost - The hostname of this machine.
      webServerPort - The port number on which the webserver shall
              listen for connection requests.
      serverHostname - The hostname for this machine. Please do not
              use shell variables to specify the hostname.

2 Install VPN server.
  - The installation instructions for this step are present in
    VPNSetup/strongswan-config-steps.txt.
  - This step internally exports MEDDLE_ROOT which ensures that
    MEDDLE_ROOT is available for the following steps.

3 Install the database schema.
  - The installation instructions are present in the file
    DatabaseSetup/setup.txt.

4 Install files to configure the DNS server for AD blocking.
  - The installation steps are present in the file
    AdblockDNS/installation-steps.txt

5 Install the Meddle system.
  - Meddle requires mysql-devel and boost. Please make sure that the
    mysql-devel package and all boost libraries are installed.
  - The MeddleSystem/Makefile contains the library path for 64bit
    machines. If compiling on a 32 bit machine then modify the path
    (replacing lib64 with lib does the trick). The command
    mysql_config --libs
    can be used to get the paths and the libraries that need to be present.
  - Meddle system can be compiled and installed using the following commands.
    cd MeddleSystem
    make
    sudo make install

6 Install the web server
  - Enter the MEDDLE_ROOT/WebServer folder and execute the following command.
    sudo ./install.sh

7 Place the web pages in the appropriate folder
  - Enter the MEDDLE_ROOT/WebPages folder and execute
    sudo ./install.sh
  - If the Webserver is listening on a port other than port 80 then
    replace 10.11.101.101 in MEDDLE_ROOT/WebPages/index.html. with the
    values of tunIpAddress:webServerPort present meddle.config file.
    For example, replace 10.11.101.101 with 10.11.101.101:8080 if the
    tunIpAddress is 10.11.101.101 and the webServerPort is 8080.

8 Test tcpdump
  - The pcapDataPath in the meddle.config file contains the location
    where the pcap files are saved. To test if tcpdump can write to
    this location change to the location specified by pcapDataPath and
    execute
      sudo tcpdump -i lo -w abc.
      Press Ctrl-C after some time and test if abc was created. 
  - If tcpdump is not install then install tcpdump
  - If tcpdump is present and is unable to write in the given
    directory then execute the following commands.
      sudo /sbin/setcap cap_net_raw+eip /usr/sbin/tcpdump
    On Ubuntu/debian you might also need to execute the following
    command.
      sudo aa-complain /usr/sbin/tcpdump
  - Meddle also requires ksh to be installed

9 Test gpg
  - Install gpg if gpg command fails. (I do not remember the name of the 
    gpg package because gpg was present on the machine in which I installed
    Meddle).
  - All the pcap files are encrypted using gpg to protect the privacy
    of the users using Meddle in case the server is compromised.
  - To test if gpg works execute
      sudo gpg --homedir=${MEDDLE_ROOT}/gpg
      (Make sure that MEDDLE_ROOT is defined).
      Press Ctrl-C after seeing
      "gpg: Go ahead and type your message ..."

10 Create and install the certificates for CA and the server.
  - Change directory to ${MEDDLE_ROOT}/credential-mgmt/
  - Make sure that the ${MEDDLE_ROOT}/meddle.config has the right
    values for CERTIFICATE PARAMETERS.
  - Create and install the CA certificates with the command.
      sudo ./gen-CA-Certs.sh
  - Create and install the server certificates with the command.
     sudo ./gen-Server-Certs.sh
  - This step ensures that the certificates are installed in the
    location that strongswan expects to find them

11 Enable packet forwarding
  - Packet forwarding is enabled with the following command.
      sudo sysctl -w net.ipv4.ip_forward=1
      cat /proc/sys/net/ipv4/ip_forward
    The output of the cat command should be 1
  - Add the following three lines to /etc/sysctl.conf  to make sure
    that this setting is preserved across reboots. The comments ensure
    that by doing a grep for Meddle you can edit the changes if
    required.
# Meddle changes begin here.
net.ipv4.ip_forward=1
# Meddle modifications end here.
 
  - Meddle internally loops the packets through the tunnel
    device. This is made possible by adding the following five lines
    to /etc/iproute2/rt_tables.
# Meddle changes come here. These line name tables that are referred to by Meddle
5 fwdpath
6 revpath
7 depart
# Meddle modifications end here

12 Start Meddle
  - First check if mysql is running by executing
      sudo service mysqld status
    If it is not running then start mysql
      sudo service mysqld start
  - Change to ${MEDDLE_ROOT}/usr/sbin/ and become root user by executing
      sudo su
  - Start meddle by the following command
      ./SetupMeddle.sh start
    Ignore messages related to checksum (csum) and offloading (offload setting)
    Meddle can be stopped if required by executing ./SetupMeddle.sh stop   
  - Note that a suggested logname for the webserver is printed in the
    last message of this script. This can be used in the following
    step if required.

13 Start the web server
  - The Webserver internally uses the mysql bindings for python. These
    bindings are available if the MySQL-python and
    mysql-connector-python packages are installed in Fedora.
    For Ubuntu/Debian the python-mysqldb and python-mysqldb-dbg
    packages need to be installed.
  - The following commands shall start a trial run of the webserver
      cd  ${MEDDLE_ROOT}/WebServer
      sudo su
      python MainServer.sh path_to_meddle_config/meddle.config.
    If the program quits with an exception then please report the
    reason. I shall try to see if I missed out one some
    dependencies. If it does not crash then try to access the pages
    from a web browser.
  - If the simple test passes then start the webserver as a background process.
    python MainServer.sh ${MEDDLE_ROOT}/meddle.config >> ${MEDDLE_ROOT}/logs/webServer.log 2>&1 &

14 Start the DNS server
  - The DNS server which is required for ad blocking can be started by
     sudo service named restart
     or
     sudo service bind9 restart

15 Create user accounts
  - Step 15 and Step 16 should be performed each time a new user
    account needs to be created.
  - A user account with a random user name and password can be created
    by the addMeddleUser.sh script in ${MEDDLE_ROOT}/credential-mgmt
    folder. A random user name is chosen to protect the privacy of the
    users and shall be useful in anonymizing the traces at a later
    date.
  - The following commands shall create a new user account
      cd ${MEDDLE_ROOT}/credential-mgmt
      sudo ./addMeddleUser.sh.
    PLEASE NOTE DOWN THE PASSWORD AND USERNAME THAT IS DISPLAYED AT
    THE END OF THIS STEP.
  - This program shall create new certificates and configurations
    files in the ${clientCertsPath}.
  - iOS users should install the .mobileconfig file while Android
    users need to install the .p12 file.
  - It would be nice to maintain a log file or spread sheet of device
    type assosciated with each account.

16 Email credentials to the users.
  - Note down the username and password and copy the .p12 file or the
    .mobileconfig file that has been created and attach it to an email
    with the following message. Do not forget to replace <password> with
    the password displayed in Step 15
---
The attachment contains the certificates required by Meddle.

The installation password for the certificates is <password>

The installation instructions are available at
http://meddle.cs.washington.edu/android.html
http://meddle.cs.washington.edu/iOS.html

The VPN app (mentioned in Step 3) for Android devices is available at
http://sounder.cs.washington.edu/apk/MeddleVPN.apk
---

17 Test VPN connection
  - Install the credentials using the VPN server following instructions
    available at http://meddle.cs.washington.edu.
  - For sanity check if a folder for the user is created in
    ${MEDDLE_ROOT}/pcap-data/ ($pcapDataPath) when the user creates a
    VPN tunnel. Also check if pcap files are created in this folder.

If you are stuck in any step of this installation process please feel
free to email ashwin.rao@inria.fr with your problem.
